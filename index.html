<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0a0b12" />
  <meta name="color-scheme" content="dark" />

  <!-- PWA-ish meta (single-file constraints apply) -->
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="LitRPG Omni-Tool" />
  <meta name="application-name" content="LitRPG Omni-Tool" />

  <!-- Single-file manifest via data: URL -->
  <link rel="manifest" id="manifestLink" href="">
  <!-- Single-file icon via data: URL (SVG) -->
  <link rel="icon" id="faviconLink" href="">
  <link rel="apple-touch-icon" id="appleIconLink" href="">

  <title>LitRPG Omni-Tool (Single File)</title>

  <style>
    :root{
      --bg0:#070812;
      --bg1:#0a0b12;
      --bg2:#0f1020;
      --panel:#0c0d18cc;
      --line:#1e2140;
      --txt:#e7e9ff;
      --muted:#9aa0d6;
      --danger:#ff3b6b;
      --ok:#39ffb6;
      --a:#00e5ff;
      --b:#b84dff;
      --c:#ff2fd6;
      --shadow: 0 12px 36px rgba(0,0,0,.45);
      --r: 16px;
      --r2: 22px;
      --pad: 14px;
      --tap: 44px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--txt);
      background:
        radial-gradient(1100px 600px at 15% 5%, rgba(0,229,255,.16), transparent 55%),
        radial-gradient(900px 520px at 85% 10%, rgba(184,77,255,.18), transparent 60%),
        radial-gradient(1000px 650px at 50% 95%, rgba(255,47,214,.12), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg1) 40%, #060611);
      overflow-x:hidden;
    }

    /* Neon grid */
    body::before{
      content:"";
      position:fixed; inset:0;
      background:
        linear-gradient(to right, rgba(0,229,255,.04) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(184,77,255,.04) 1px, transparent 1px);
      background-size: 28px 28px;
      pointer-events:none;
      mix-blend-mode:screen;
      opacity:.6;
    }

    a{ color:var(--a); }
    button, input, select, textarea{ font:inherit; color:inherit; }
    input, textarea, select{
      width:100%;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      outline:none;
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(0,229,255,.55);
      box-shadow: 0 0 0 3px rgba(0,229,255,.12);
    }

    .app{
      min-height:100%;
      display:flex;
      flex-direction:column;
      padding-bottom: 76px; /* space for bottom nav */
    }

    .topbar{
      position:sticky; top:0; z-index:50;
      padding: 10px 12px calc(10px + env(safe-area-inset-top)) 12px;
      background: linear-gradient(180deg, rgba(10,11,18,.92), rgba(10,11,18,.74));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(30,33,64,.9);
    }
    .topbarRow{
      display:flex; align-items:center; gap:10px;
    }
    .brand{
      display:flex; flex-direction:column; gap:2px;
      min-width: 0;
    }
    .brandTitle{
      font-weight: 800;
      letter-spacing:.4px;
      line-height: 1.05;
      font-size: 14px;
      text-shadow: 0 0 18px rgba(0,229,255,.18);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brandSub{
      font-size: 12px;
      color: var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(30,33,64,.9);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      box-shadow: 0 8px 22px rgba(0,0,0,.25);
      min-height: var(--tap);
    }
    .chip .dot{
      width:10px; height:10px; border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.3));
      box-shadow: 0 0 16px rgba(0,229,255,.35), 0 0 32px rgba(184,77,255,.2);
      background-color: var(--a);
    }
    .chip strong{ font-size: 12px; }
    .chip span{ font-size: 12px; color: var(--muted); }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      min-height: var(--tap);
      padding: 10px 14px;
      border-radius: 16px;
      border:1px solid rgba(30,33,64,.95);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      box-shadow: 0 10px 24px rgba(0,0,0,.28);
      cursor:pointer;
      user-select:none;
      transition: transform .08s ease, filter .12s ease, border-color .12s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active{ transform: translateY(1px) scale(.99); filter: brightness(1.05); }
    .btn.primary{
      border-color: rgba(0,229,255,.35);
      background:
        radial-gradient(120px 60px at 20% 30%, rgba(0,229,255,.22), transparent 60%),
        radial-gradient(160px 70px at 85% 40%, rgba(184,77,255,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    }
    .btn.danger{
      border-color: rgba(255,59,107,.45);
      background:
        radial-gradient(160px 70px at 30% 40%, rgba(255,59,107,.22), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
    }
    .btn.ghost{
      background: rgba(255,255,255,.03);
      box-shadow:none;
    }
    .btn.small{ min-height: 40px; padding: 8px 12px; border-radius: 14px; font-size: 13px; }
    .btn.square{ width: var(--tap); padding: 0; }

    .content{
      padding: 12px 12px 0;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }

    .card{
      border:1px solid rgba(30,33,64,.95);
      border-radius: var(--r2);
      background: linear-gradient(180deg, rgba(12,13,24,.92), rgba(10,11,18,.78));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardHeader{
      padding: 12px 12px 10px;
      border-bottom: 1px solid rgba(30,33,64,.8);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .cardHeader h2{
      margin:0;
      font-size: 14px;
      letter-spacing:.4px;
    }
    .cardHeader p{
      margin:0;
      font-size:12px;
      color:var(--muted);
    }
    .cardBody{ padding: 12px; }
    .grid{
      display:grid;
      gap:10px;
    }
    .grid.two{ grid-template-columns: 1fr 1fr; }
    .grid.three{ grid-template-columns: 1fr 1fr 1fr; }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .row.wrap{ flex-wrap:wrap; }
    .row > *{ flex:1; }
    .row.tight > *{ flex: unset; }

    .label{
      font-size:12px;
      color:var(--muted);
      margin: 0 0 6px;
    }
    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
    }
    .sep{
      height:1px;
      background: rgba(30,33,64,.85);
      margin: 10px 0;
    }

    .list{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .item{
      border:1px solid rgba(30,33,64,.9);
      border-radius: var(--r);
      background: rgba(255,255,255,.03);
      padding: 10px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .itemTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-width:0;
    }
    .itemTitle{
      font-weight: 700;
      font-size: 13px;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .itemMeta{
      font-size: 12px;
      color: var(--muted);
    }
    .pill{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      border:1px solid rgba(30,33,64,.9);
      color: var(--muted);
      background: rgba(0,0,0,.15);
      white-space:nowrap;
    }

    /* Bottom nav */
    .nav{
      position:fixed;
      left:0; right:0; bottom:0;
      padding: 10px 10px calc(10px + env(safe-area-inset-bottom));
      background: linear-gradient(180deg, rgba(10,11,18,.35), rgba(10,11,18,.92));
      backdrop-filter: blur(10px);
      border-top: 1px solid rgba(30,33,64,.9);
      z-index: 60;
    }
    .navGrid{
      display:grid;
      grid-template-columns: repeat(5, 1fr);
      gap:10px;
    }
    .tabBtn{
      min-height: 52px;
      border-radius: 18px;
      border:1px solid rgba(30,33,64,.9);
      background: rgba(255,255,255,.03);
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:4px;
      cursor:pointer;
      transition: filter .12s ease, transform .08s ease, border-color .12s ease;
      -webkit-tap-highlight-color: transparent;
      user-select:none;
    }
    .tabBtn:active{ transform: translateY(1px) scale(.99); }
    .tabBtn .ico{ font-size: 16px; filter: drop-shadow(0 0 10px rgba(0,229,255,.12)); }
    .tabBtn .txt{ font-size: 11px; color: var(--muted); }
    .tabBtn.active{
      border-color: rgba(0,229,255,.38);
      background:
        radial-gradient(120px 70px at 30% 40%, rgba(0,229,255,.20), transparent 60%),
        radial-gradient(130px 70px at 80% 40%, rgba(184,77,255,.16), transparent 60%),
        rgba(255,255,255,.04);
    }
    .tabBtn.active .txt{ color: var(--txt); }

    /* Editor */
    .editorShell{
      border:1px solid rgba(30,33,64,.95);
      border-radius: var(--r2);
      overflow:hidden;
      background: rgba(0,0,0,.18);
    }
    .toolbar{
      padding: 10px;
      border-bottom: 1px solid rgba(30,33,64,.85);
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .toolbar .btn{ flex: 0 0 auto; }
    .toolbar .colorWrap{
      display:flex; align-items:center; gap:8px;
      border:1px solid rgba(30,33,64,.9);
      border-radius: 14px;
      padding: 6px 10px;
      background: rgba(255,255,255,.03);
      min-height: 40px;
    }
    .toolbar input[type="color"]{
      width: 42px;
      height: 30px;
      padding: 0;
      border-radius: 12px;
      border:1px solid rgba(30,33,64,.9);
      background: transparent;
    }
    .toolbar .modePill{
      margin-left:auto;
      display:flex;
      gap:8px;
      align-items:center;
      flex: 1 1 auto;
      justify-content:flex-end;
    }
    .toggle{
      display:inline-flex;
      border:1px solid rgba(30,33,64,.95);
      border-radius: 999px;
      overflow:hidden;
      background: rgba(255,255,255,.03);
    }
    .toggle button{
      border:0;
      padding: 8px 12px;
      background: transparent;
      cursor:pointer;
      min-height: 40px;
      color: var(--muted);
    }
    .toggle button.active{
      color: var(--txt);
      background:
        radial-gradient(110px 50px at 30% 40%, rgba(0,229,255,.18), transparent 60%),
        rgba(255,255,255,.05);
    }

    .editorArea{
      min-height: 48vh;
      padding: 14px 12px;
      line-height: 1.55;
      font-size: 15px;
      outline: none;
      word-break: break-word;
    }
    .editorArea[contenteditable="true"]:empty:before{
      content: attr(data-placeholder);
      color: rgba(154,160,214,.7);
    }
    .codeArea{
      display:none;
      width:100%;
      min-height: 48vh;
      padding: 14px 12px;
      border:0;
      border-radius:0;
      background: transparent;
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.55;
      resize: vertical;
      outline:none;
    }
    .focusMode .topbar,
    .focusMode .nav,
    .focusMode .hideOnFocus{
      display:none !important;
    }
    .focusMode .content{
      padding-top: 12px;
      padding-bottom: 12px;
    }
    .focusMode .editorArea,
    .focusMode .codeArea{
      min-height: calc(100vh - 90px);
    }

    /* Status table inserted into text */
    .statusTable{
      width:100%;
      border-collapse: collapse;
      margin: 10px 0;
      font-size: 13px;
      overflow:hidden;
      border-radius: 16px;
      border: 1px solid rgba(30,33,64,.95);
      background:
        radial-gradient(240px 110px at 20% 20%, rgba(0,229,255,.12), transparent 60%),
        radial-gradient(240px 110px at 85% 35%, rgba(184,77,255,.10), transparent 60%),
        rgba(0,0,0,.22);
    }
    .statusTable thead th{
      text-align:left;
      padding: 10px;
      font-weight: 800;
      letter-spacing:.3px;
      border-bottom: 1px solid rgba(30,33,64,.8);
    }
    .statusTable td{
      padding: 9px 10px;
      border-bottom: 1px solid rgba(30,33,64,.55);
    }
    .statusTable tr:last-child td{ border-bottom: none; }
    .statusTable td:nth-child(2){
      text-align:right;
      font-family: var(--mono);
      color: #dffcff;
    }
    .statusBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 12px;
      color: var(--muted);
    }
    .statusBadge .glow{
      width:10px; height:10px; border-radius: 999px;
      background: var(--ok);
      box-shadow: 0 0 18px rgba(57,255,182,.35);
    }

    /* Error HUD */
    .errorHud{
      position: fixed;
      left: 12px;
      right: 12px;
      top: 12px;
      z-index: 9999;
      display:none;
      border-radius: 18px;
      border:1px solid rgba(255,59,107,.55);
      background:
        radial-gradient(380px 180px at 20% 30%, rgba(255,59,107,.18), transparent 60%),
        linear-gradient(180deg, rgba(18,10,14,.92), rgba(12,8,10,.85));
      box-shadow: 0 18px 46px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .errorHudHeader{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      border-bottom: 1px solid rgba(255,59,107,.35);
    }
    .errorHudHeader strong{ font-size: 13px; }
    .errorHudBody{
      padding: 10px 12px;
      font-family: var(--mono);
      font-size: 12px;
      white-space: pre-wrap;
      color: #ffd6df;
      max-height: 40vh;
      overflow:auto;
    }

    .kbd{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--muted);
      border:1px solid rgba(30,33,64,.9);
      background: rgba(0,0,0,.18);
      border-radius: 10px;
      padding: 2px 8px;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }

    .miniNote{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.35;
      margin: 0;
    }

    .badgeLive{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,229,255,.35);
      background: rgba(0,229,255,.06);
      color: #c7fbff;
      box-shadow: 0 10px 24px rgba(0,0,0,.24);
    }
    .badgeLive .rec{
      width: 10px; height:10px; border-radius:999px;
      background: var(--danger);
      box-shadow: 0 0 16px rgba(255,59,107,.35);
      animation: pulse 1.1s ease-in-out infinite;
    }
    @keyframes pulse{
      0%,100%{ transform: scale(.9); opacity:.7; }
      50%{ transform: scale(1.15); opacity:1; }
    }

    .muted{ color:var(--muted); }

    @media (min-width: 860px){
      .content{
        max-width: 1050px;
        margin: 0 auto;
      }
      .nav{
        left: 50%;
        transform: translateX(-50%);
        max-width: 1050px;
        border-left: 1px solid rgba(30,33,64,.9);
        border-right: 1px solid rgba(30,33,64,.9);
        border-top-left-radius: 18px;
        border-top-right-radius: 18px;
      }
      .topbar{
        left: 50%;
        transform: translateX(-50%);
        max-width: 1050px;
        border-left: 1px solid rgba(30,33,64,.9);
        border-right: 1px solid rgba(30,33,64,.9);
        border-bottom-left-radius: 18px;
        border-bottom-right-radius: 18px;
      }
    }
  
    /* ---------- Compact UI ---------- */
    body.compact{
      --pad: 10px;
      --tap: 40px;
      --r: 14px;
      --r2: 18px;
    }
    body.compact .brandSub{ display:none; }
    body.compact #chipChapterTitle{ display:none; }
    body.compact .cardHeader p,
    body.compact .hint,
    body.compact .miniNote{ display:none; }
    body.compact .stack{ gap: 8px; }
    body.compact .btn{ padding: 8px 10px; gap: 6px; }
    .btn.iconOnly{ padding: 8px 10px; min-width: 40px; }
    body.compact .navGrid{ gap:8px; }
    body.compact .tabBtn{ min-height: 46px; border-radius: 16px; }
    body.compact .nav .txt{ display:none; }
    body.compact .topbar{ padding: 10px 12px 8px; }
    body.compact .topbarRow{ gap: 10px; }
    body.compact .chip{ padding: 10px 12px; border-radius: 16px; }
    body.compact .btnText{ display:none; }

    /* ---------- Light theme (neon but bright) ---------- */
    html[data-theme="light"]{
      --bg0:#f6f7ff;
      --bg1:#eff1ff;
      --bg2:#e6e9ff;
      --panel:#ffffffcc;
      --line:#cfd3ff;
      --txt:#101128;
      --muted:#4d4f7a;
      --shadow: 0 10px 28px rgba(18,20,56,.14);
    }
    html[data-theme="light"] body{
      background:
        radial-gradient(900px 540px at 20% 8%, rgba(0,229,255,.18), transparent 60%),
        radial-gradient(1000px 700px at 80% 0%, rgba(184,77,255,.16), transparent 60%),
        radial-gradient(900px 700px at 50% 95%, rgba(255,47,214,.10), transparent 55%),
        linear-gradient(180deg, var(--bg0), var(--bg2));
    }
    html[data-theme="light"] .topbar{
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(247,248,255,.78));
      border-bottom: 1px solid rgba(207,211,255,.95);
      box-shadow: 0 10px 22px rgba(18,20,56,.10);
    }
    html[data-theme="light"] .nav{
      background: rgba(255,255,255,.88);
      border-top: 1px solid rgba(207,211,255,.95);
      box-shadow: 0 -10px 24px rgba(18,20,56,.10);
    }
    html[data-theme="light"] .card{
      border-color: rgba(207,211,255,.95);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(247,248,255,.78));
      box-shadow: var(--shadow);
    }
    html[data-theme="light"] .btn{
      border-color: rgba(207,211,255,.95);
      box-shadow: 0 8px 18px rgba(18,20,56,.12);
      background: linear-gradient(180deg, rgba(10,11,18,.04), rgba(10,11,18,.01));
    }
    html[data-theme="light"] input,
    html[data-theme="light"] textarea,
    html[data-theme="light"] select{
      background: linear-gradient(180deg, rgba(10,11,18,.04), rgba(10,11,18,.01));
    }


    /* ---------- App-like shell improvements ---------- */

    .page{
      border: 1px solid var(--line);
      border-radius: var(--r);
      background: var(--panel);
      box-shadow: var(--shadow);
      padding: 12px;
    }
    .pageTop{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(255,255,255,.06);
      margin-bottom: 10px;
    }
    [data-theme="light"] .pageTop{
      border-bottom: 1px solid rgba(0,0,0,.06);
    }

    :root{
      --headerH: 62px;
      --navH: 66px;
    }
    .content{
      padding-bottom: calc(var(--navH) + env(safe-area-inset-bottom));
    }
    .topbar{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(12px);
    }

    /* Bottom navigation */
    .bottomNav{
      position: fixed;
      left: 0; right: 0; bottom: 0;
      height: calc(var(--navH) + env(safe-area-inset-bottom));
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom));
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      background: linear-gradient(180deg, rgba(8,10,16,.75), rgba(8,10,16,.92));
      border-top: 1px solid rgba(255,255,255,.08);
      box-shadow: 0 -20px 60px rgba(0,0,0,.35);
      backdrop-filter: blur(14px);
      z-index: 80;
    }
    [data-theme="light"] .bottomNav{
      background: linear-gradient(180deg, rgba(250,252,255,.78), rgba(242,245,255,.92));
      border-top: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 -20px 60px rgba(0,0,0,.12);
    }
    .navBtn{
      position: relative;
      border: 1px solid rgba(255,255,255,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border-radius: 18px;
      padding: 8px 6px;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap: 4px;
      min-width: 0;
      cursor: pointer;
      transition: transform .14s ease, border-color .2s ease, background .2s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .navBtn .ico{ font-size: 18px; line-height: 1; }
    .navBtn .lbl{ font-size: 11px; opacity:.82; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%; }
    body.compact .navBtn .lbl{ display:none; }
    .navBtn:active{ transform: scale(.98); }
    .navBtn.active{
      border-color: rgba(0,229,255,.35);
      background: radial-gradient(120px 60px at 50% 0%, rgba(0,229,255,.14), rgba(255,255,255,.03));
      box-shadow: 0 0 0 1px rgba(0,229,255,.10), 0 16px 40px rgba(0,229,255,.06);
    }
    [data-theme="light"] .navBtn{
      border: 1px solid rgba(0,0,0,.08);
      background: linear-gradient(180deg, rgba(255,255,255,.88), rgba(245,248,255,.74));
    }
    [data-theme="light"] .navBtn.active{
      border-color: rgba(123,97,255,.35);
      box-shadow: 0 0 0 1px rgba(123,97,255,.10), 0 16px 40px rgba(123,97,255,.10);
    }
    .navIndicator{
      position:absolute;
      left:12px; right:12px;
      height: 3px;
      bottom: calc(8px + env(safe-area-inset-bottom));
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(0,229,255,.0), rgba(0,229,255,.8), rgba(184,77,255,.8), rgba(0,229,255,.0));
      opacity: .9;
      transform: translateX(0);
      pointer-events:none;
      filter: blur(.1px);
    }

    /* Page transition animations */
    @keyframes pageInRight { from{ opacity:0; transform: translateX(10px);} to{opacity:1; transform: translateX(0);} }
    @keyframes pageInLeft  { from{ opacity:0; transform: translateX(-10px);} to{opacity:1; transform: translateX(0);} }
    @keyframes pageOutLeft { from{ opacity:1; transform: translateX(0);} to{opacity:0; transform: translateX(-10px);} }
    @keyframes pageOutRight{ from{ opacity:1; transform: translateX(0);} to{opacity:0; transform: translateX(10px);} }
    .tabAnimInRight{ animation: pageInRight .18s ease both; }
    .tabAnimInLeft{ animation: pageInLeft .18s ease both; }
    .tabAnimOutLeft{ animation: pageOutLeft .16s ease both; }
    .tabAnimOutRight{ animation: pageOutRight .16s ease both; }

    /* Segmented tabs */
    .segTabs{
      display:flex;
      gap:8px;
      padding: 10px 2px 2px;
      margin-bottom: 12px;
      position: sticky;
      top: calc(var(--headerH) + 2px);
      z-index: 10;
      backdrop-filter: blur(10px);
    }
    .segBtn{
      flex:1;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      padding: 10px 10px;
      cursor:pointer;
      transition: transform .14s ease, border-color .2s ease;
    }
    .segBtn.active{
      border-color: rgba(0,229,255,.35);
      box-shadow: 0 0 0 1px rgba(0,229,255,.10), 0 16px 40px rgba(0,229,255,.06);
    }
    [data-theme="light"] .segBtn{
      border: 1px solid rgba(0,0,0,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.92), rgba(245,248,255,.78));
    }
    [data-theme="light"] .segBtn.active{
      border-color: rgba(123,97,255,.35);
      box-shadow: 0 0 0 1px rgba(123,97,255,.10), 0 16px 40px rgba(123,97,255,.10);
    }
    .switchRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 0;
      border-top: 1px solid rgba(255,255,255,.06);
    }
    [data-theme="light"] .switchRow{
      border-top: 1px solid rgba(0,0,0,.06);
    }
    .switchRow input[type="checkbox"]{
      width: 46px;
      height: 26px;
      appearance: none;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      position: relative;
      outline: none;
      cursor: pointer;
    }
    [data-theme="light"] .switchRow input[type="checkbox"]{
      border: 1px solid rgba(0,0,0,.14);
      background: rgba(0,0,0,.06);
    }
    .switchRow input[type="checkbox"]::after{
      content:"";
      position:absolute;
      top: 3px; left: 3px;
      width: 20px; height: 20px;
      border-radius: 50%;
      background: rgba(255,255,255,.88);
      transition: transform .16s ease;
    }
    .switchRow input[type="checkbox"]:checked{
      border-color: rgba(0,229,255,.35);
      background: rgba(0,229,255,.14);
    }
    [data-theme="light"] .switchRow input[type="checkbox"]:checked{
      border-color: rgba(123,97,255,.35);
      background: rgba(123,97,255,.16);
    }
    .switchRow input[type="checkbox"]:checked::after{
      transform: translateX(20px);
    }

    /* Reduced motion */
    body.reducedMotion *, body.reducedMotion *::before, body.reducedMotion *::after{
      animation-duration: .001ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: .001ms !important;
      scroll-behavior: auto !important;
    }

    /* Font scale */
    html{ font-size: calc(16px * (var(--fontScale, 1))); }
</style>
</head>
<body>
  <div class="errorHud" id="errorHud">
    <div class="errorHudHeader">
      <strong>‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</strong>
      <button class="btn small danger" id="errorHudClose">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    <div class="errorHudBody" id="errorHudBody"></div>
  </div>

  <div class="app" id="app">
    <div class="topbar" id="topbar">
      <div class="topbarRow">
        <div class="chip" title="–¢–µ–∫—É—â–∞—è –∫–Ω–∏–≥–∞">
          <span class="dot"></span>
          <div style="display:flex;flex-direction:column;gap:1px;min-width:0;">
            <strong id="chipBookTitle">‚Äî</strong>
            <span id="chipChapterTitle">‚Äî</span>
          </div>
        </div>
        <div class="row tight" style="gap:8px;flex:0;">
          <button class="btn small ghost" id="btnFocus" title="–§–æ–∫—É—Å-—Ä–µ–∂–∏–º (—Å–∫—Ä—ã—Ç—å UI)">üéØ <span class="btnText">–§–æ–∫—É—Å</span></button>
          <button class="btn small ghost iconOnly" id="btnTheme" title="–¢–µ–º–∞: —Å–≤–µ—Ç–ª–∞—è/—Ç—ë–º–Ω–∞—è" aria-label="–¢–µ–º–∞">üåô</button>
          <button class="btn small ghost iconOnly" id="btnCompact" title="–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º" aria-label="–ö–æ–º–ø–∞–∫—Ç">‚ÜïÔ∏è</button>
        </div>
      </div>
      <div style="height:8px"></div>
      <div class="topbarRow">
        <div class="brand" style="flex:1;min-width:0;">
          <div class="brandTitle">LitRPG Omni-Tool</div>
          <div class="brandSub" id="brandSub">Single-file Writer IDE + RPG –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</div>
        </div>
        <button class="btn small primary" id="btnQuickStatus" title="–í—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –≤ —Ç–µ–∫—É—â–∏–π —Ç–µ–∫—Å—Ç">üìã <span class="btnText">–°—Ç–∞—Ç—É—Å</span></button>
      </div>
    </div>

    <div class="content" id="content">
      <!-- TAB: Library -->
      <section class="card" id="tab-library" style="display:none;">
        <div class="cardHeader">
          <div>
            <h2>–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞</h2>
            <p>–ö–Ω–∏–≥–∏ ‚Üí –¢–æ–º(–∞) ‚Üí –ì–ª–∞–≤—ã (—É –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–∏ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è RPG-—Å–∏—Å—Ç–µ–º–∞ –∏ —Ç–µ–∫—Å—Ç)</p>
          </div>
          <button class="btn small primary" id="btnNewBook">‚ûï –ö–Ω–∏–≥–∞</button>
        </div>
        <div class="cardBody">
          <div class="grid" style="gap:14px;">
            <div class="card" style="box-shadow:none;">
              <div class="cardHeader">
                <div>
                  <h2 style="margin:0;font-size:13px;">–ö–Ω–∏–≥–∏</h2>
                  <p style="margin:0;">–°–æ–∑–¥–∞–≤–∞–π—Ç–µ/–ø–µ—Ä–µ–∫–ª—é—á–∞–π—Ç–µ</p>
                </div>
                <button class="btn small" id="btnRenameBook">‚úèÔ∏è</button>
              </div>
              <div class="cardBody">
                <div class="list" id="bookList"></div>
              </div>
            </div>

            <div class="card" style="box-shadow:none;">
              <div class="cardHeader">
                <div>
                  <h2 style="margin:0;font-size:13px;">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ–∫—É—â–µ–π –∫–Ω–∏–≥–∏</h2>
                  <p style="margin:0;">–¢–æ–º–∞ –∏ –≥–ª–∞–≤—ã</p>
                </div>
                <div class="row tight" style="gap:8px;">
                  <button class="btn small" id="btnNewVolume">‚ûï –¢–æ–º</button>
                  <button class="btn small primary" id="btnNewChapter">‚ûï –ì–ª–∞–≤–∞</button>
                </div>
              </div>
              <div class="cardBody">
                <div class="list" id="treeList"></div>
                <div class="sep"></div>
                <p class="miniNote">
                  –°–æ–≤–µ—Ç: –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –≤—Å—Ç–∞–≤–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <span class="kbd">üìã –°—Ç–∞—Ç—É—Å</span> —Å–≤–µ—Ä—Ö—É –∏–ª–∏ –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ.
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- TAB: God Mode -->
      <section class="card" id="tab-god" style="display:none;">
        <div class="cardHeader">
          <div>
            <h2>God Mode ‚Äî –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä RPG</h2>
            <p>–ê—Ç—Ä–∏–±—É—Ç—ã, —Ñ–æ—Ä–º—É–ª—ã –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã—Ö —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É—Ä–æ–≤–Ω–µ–π</p>
          </div>
          <button class="btn small primary" id="btnAddAttr">‚ûï –ê—Ç—Ä–∏–±—É—Ç</button>
        </div>
        <div class="cardBody">
          <div class="grid" style="gap:14px;">
            <div class="card" style="box-shadow:none;">
              <div class="cardHeader">
                <div>
                  <h2 style="margin:0;font-size:13px;">–ê—Ç—Ä–∏–±—É—Ç—ã</h2>
                  <p style="margin:0;">–ö–æ–¥ (STR), –∏–º—è, –±–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ</p>
                </div>
              </div>
              <div class="cardBody">
                <div class="list" id="attrList"></div>
                <div class="sep"></div>
                <p class="hint">
                  <strong>–ü—Ä–∞–≤–∏–ª–æ –∫–æ–¥–æ–≤:</strong> –ª–∞—Ç–∏–Ω–∏—Ü–∞/—Ü–∏—Ñ—Ä—ã/–ø–æ–¥—á—ë—Ä–∫–∏–≤–∞–Ω–∏—è, –ª—É—á—à–µ –í–ï–†–•–ù–ò–ô –†–ï–ì–ò–°–¢–† (–ø—Ä–∏–º–µ—Ä: <span class="kbd">STR</span>, <span class="kbd">VIT</span>, <span class="kbd">LVL</span>).<br/>
                  <strong>LVL</strong> –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –∫–∞–∫ —É—Ä–æ–≤–µ–Ω—å –≥–µ—Ä–æ—è.
                </p>
              </div>
            </div>

            <div class="card" style="box-shadow:none;">
              <div class="cardHeader">
                <div>
                  <h2 style="margin:0;font-size:13px;">–ü—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h2>
                  <p style="margin:0;">–§–æ—Ä–º—É–ª—ã (–ø—Ä–∏–º–µ—Ä: HP = (VIT*10)+(STR*2)+(LVL*5))</p>
                </div>
                <button class="btn small primary" id="btnAddDerived">‚ûï –§–æ—Ä–º—É–ª–∞</button>
              </div>
              <div class="cardBody">
                <div class="list" id="derivedList"></div>
                <div class="sep"></div>
                <div class="grid two">
                  <div>
                    <div class="label">–û—á–∫–æ–≤ –∑–∞ —É—Ä–æ–≤–µ–Ω—å</div>
                    <input type="number" id="pointsPerLevel" min="0" step="1" />
                  </div>
                  <div>
                    <div class="label">–ë—ã—Å—Ç—Ä—ã–π –ø—Ä–∏–º–µ—Ä</div>
                    <button class="btn small" id="btnSeedExample">‚ú® –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ø—Ä–∏–º–µ—Ä</button>
                  </div>
                </div>
                <div class="sep"></div>
                <button class="btn small" id="btnRecalcNow">üîÅ –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Å–µ–π—á–∞—Å</button>
                <p class="miniNote muted" id="recalcHint" style="margin-top:10px;"></p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- TAB: Hero -->
      <section class="card" id="tab-hero" style="display:none;">
        <div class="cardHeader">
          <div>
            <h2>Character Sheet</h2>
            <p>–£—Ä–æ–≤–µ–Ω—å, —Å–≤–æ–±–æ–¥–Ω—ã–µ –æ—á–∫–∏, —Ç–µ–∫—É—â–∏–µ —Å—Ç–∞—Ç—ã</p>
          </div>
          <div class="row tight" style="gap:8px;">
            <button class="btn small" id="btnLevelUp">‚¨ÜÔ∏è Level Up</button>
            <button class="btn small ghost" id="btnResetAlloc">‚ôªÔ∏è –°–±—Ä–æ—Å –æ—á–∫–æ–≤</button>
          </div>
        </div>
        <div class="cardBody">
          <div class="grid" style="gap:14px;">
            <div class="grid two">
              <div class="item">
                <div class="itemTop">
                  <div class="itemTitle">–£—Ä–æ–≤–µ–Ω—å</div>
                  <span class="pill" id="heroLevelPill">‚Äî</span>
                </div>
                <div class="itemMeta">LVL</div>
              </div>
              <div class="item">
                <div class="itemTop">
                  <div class="itemTitle">–°–≤–æ–±–æ–¥–Ω—ã–µ –æ—á–∫–∏</div>
                  <span class="pill" id="heroFreePill">‚Äî</span>
                </div>
                <div class="itemMeta">—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç–µ –ø–æ –∞—Ç—Ä–∏–±—É—Ç–∞–º</div>
              </div>
            </div>

            <div class="card" style="box-shadow:none;">
              <div class="cardHeader">
                <div>
                  <h2 style="margin:0;font-size:13px;">–ê—Ç—Ä–∏–±—É—Ç—ã</h2>
                  <p style="margin:0;">–ë–∞–∑–∞ + –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –æ—á–∫–∏</p>
                </div>
                <button class="btn small primary" id="btnInsertStatusFromHero">üìã –í—Å—Ç–∞–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
              </div>
              <div class="cardBody">
                <div class="list" id="heroAttrList"></div>
              </div>
            </div>

            <div class="card" style="box-shadow:none;">
              <div class="cardHeader">
                <div>
                  <h2 style="margin:0;font-size:13px;">–ü—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ</h2>
                  <p style="margin:0;">–†–∞—Å—Å—á–∏—Ç–∞–Ω–æ –ø–æ —Ñ–æ—Ä–º—É–ª–∞–º</p>
                </div>
              </div>
              <div class="cardBody">
                <div class="list" id="heroDerivedList"></div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- TAB: Writer -->
      <section class="card" id="tab-write" style="display:none;">
        <div class="cardHeader">
          <div>
            <h2>Writer IDE</h2>
            <p>Visual (WYSIWYG) –∏ Code (HTML). –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage.</p>
          </div>
          <div class="row tight" style="gap:8px;">
            <button class="btn small" id="btnRenameChapter">‚úèÔ∏è –ì–ª–∞–≤–∞</button>
            <button class="btn small danger" id="btnDeleteChapter">üóëÔ∏è</button>
          </div>
        </div>

        <div class="cardBody">
          <div class="editorShell">
            <div class="toolbar">
              <button class="btn small" id="btnBold" title="–ñ–∏—Ä–Ω—ã–π"><b>B</b></button>
              <button class="btn small" id="btnItalic" title="–ö—É—Ä—Å–∏–≤"><i>I</i></button>
              <div class="colorWrap" title="–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞">
                <span class="muted" style="font-size:12px;">–¶–≤–µ—Ç</span>
                <input type="color" id="txtColor" value="#00e5ff">
              </div>
              <button class="btn small primary" id="btnInsertStatus" title="–í—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–µ —Å—Ç–∞—Ç—ã –≥–µ—Ä–æ—è —Ç–∞–±–ª–∏—Ü–µ–π">üìã –í—Å—Ç–∞–≤–∏—Ç—å –°—Ç–∞—Ç—É—Å</button>

              <button class="btn small primary" id="btnMicStart">üéôÔ∏è –ù–∞—á–∞—Ç—å –¥–∏–∫—Ç–æ–≤–∫—É</button>
              <button class="btn small danger" id="btnMicStop" disabled>‚èπ –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
              <span id="micBadge" class="badgeLive" style="display:none;"><span class="rec"></span> —Å–ª—É—à–∞—é‚Ä¶</span>

              <div class="modePill">
                <div class="toggle" role="tablist" aria-label="–†–µ–∂–∏–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞">
                  <button id="modeVisual" class="active" type="button">Visual</button>
                  <button id="modeCode" type="button">Code</button>
                </div>
                <button class="btn small ghost hideOnFocus" id="btnHelp" title="–ü–∞–º—è—Ç–∫–∞">‚ùî</button>
              </div>
            </div>

            <div id="visualEditor" class="editorArea" contenteditable="true" data-placeholder="–ü–∏—à–∏—Ç–µ –∑–¥–µ—Å—å‚Ä¶ (Visual —Ä–µ–∂–∏–º)"></div>
            <textarea id="codeEditor" class="codeArea" spellcheck="false" placeholder="HTML (Code —Ä–µ–∂–∏–º)"></textarea>
          </div>

          <div class="sep"></div>

          <div class="grid two">
            <button class="btn" id="btnSaveNow">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Å–µ–π—á–∞—Å</button>
            <button class="btn ghost" id="btnClearChapter">üßº –û—á–∏—Å—Ç–∏—Ç—å –≥–ª–∞–≤—É</button>
          </div>

          <div class="sep"></div>
          <p class="miniNote">
            <span class="kbd">Visual</span> –≤—Å—Ç–∞–≤–ª—è–µ—Ç HTML-—Ç–∞–±–ª–∏—Ü—É —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä—è–º–æ –≤ —Ç–µ–∫—Å—Ç.
            <span class="kbd">Code</span> –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–≥–∏ –≤—Ä—É—á–Ω—É—é.
          </p>
        </div>
      </section>

      <!-- TAB: Backup -->
      
      <section class="page" id="tab-settings" style="display:none;" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
        <div class="pageTop">
          <div>
            <h2 style="margin:0;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
            <p style="margin:6px 0 0;opacity:.8;">–¢–µ–º–∞, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –±—ç–∫–∞–ø</p>
          </div>
        </div>

        <div class="segTabs" role="tablist" aria-label="–í–∫–ª–∞–¥–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫">
          <button class="segBtn active" type="button" data-seg="general" role="tab" aria-selected="true">–û–±—â–µ–µ</button>
          <button class="segBtn" type="button" data-seg="backup" role="tab" aria-selected="false">–ë—ç–∫–∞–ø</button>
          <button class="segBtn" type="button" data-seg="about" role="tab" aria-selected="false">–û –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏</button>
        </div>

        <div class="segPane" data-seg-pane="general" role="tabpanel">
          <div class="grid" style="gap:12px;">
            <div class="item">
              <div class="itemTitle">–¢–µ–º–∞</div>
              <div class="itemMeta">–ù–µ–æ–Ω –≤ –¥–≤—É—Ö –≤–∞—Ä–∏–∞–Ω—Ç–∞—Ö: —Ç—ë–º–Ω–∞—è/—Å–≤–µ—Ç–ª–∞—è.</div>
              <div style="height:10px;"></div>
              <div class="row" style="gap:10px;flex-wrap:wrap;">
                <button class="btn small" type="button" id="setThemeDark">üåô –¢—ë–º–Ω–∞—è</button>
                <button class="btn small" type="button" id="setThemeLight">‚òÄÔ∏è –°–≤–µ—Ç–ª–∞—è</button>
              </div>
            </div>

            <div class="item">
              <div class="itemTitle">–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å</div>
              <div class="itemMeta">–ö–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç—å, –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ —Ñ–æ–∫—É—Å-—Ä–µ–∂–∏–º.</div>
              <div style="height:10px;"></div>
              <label class="switchRow">
                <span>–ö–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ä–µ–∂–∏–º</span>
                <input type="checkbox" id="setCompactToggle">
              </label>
              <label class="switchRow">
                <span>–§–æ–∫—É—Å-—Ä–µ–∂–∏–º (—Å–∫—Ä—ã—Ç—å UI)</span>
                <input type="checkbox" id="setFocusToggle">
              </label>
              <label class="switchRow">
                <span>–£–º–µ–Ω—å—à–∏—Ç—å –∞–Ω–∏–º–∞—Ü–∏–∏</span>
                <input type="checkbox" id="setReduceMotion">
              </label>
              <label class="switchRow">
                <span>–•–∞–ø—Ç–∏–∫–∞ (vibrate)</span>
                <input type="checkbox" id="setHaptics">
              </label>
              <div style="height:8px;"></div>
              <div class="row" style="gap:10px;align-items:center;">
                <div style="min-width:140px;opacity:.85;">–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞</div>
                <input type="range" id="setFontScale" min="90" max="120" value="100" style="flex:1;">
                <div class="pill" id="fontScalePill">100%</div>
              </div>
            </div>

            <div class="item">
              <div class="itemTitle">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</div>
              <div class="itemMeta">–ß—Ç–æ–±—ã –Ω–µ –ª–µ–∑—Ç—å –≤ –º–µ–Ω—é.</div>
              <div style="height:10px;"></div>
              <div class="row" style="gap:10px;flex-wrap:wrap;">
                <button class="btn small ghost" type="button" id="btnOpenWrite">‚úçÔ∏è –û—Ç–∫—Ä—ã—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä</button>
                <button class="btn small ghost" type="button" id="btnOpenGod">üß™ –û—Ç–∫—Ä—ã—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</button>
                <button class="btn small ghost" type="button" id="btnOpenLibrary">üìö –û—Ç–∫—Ä—ã—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É</button>
              </div>
            </div>
          </div>
        </div>

        <div class="segPane" data-seg-pane="backup" role="tabpanel" style="display:none;">
<section class="card" id="backupCard" >
        <div class="cardHeader">
          <div>
            <h2>–ë—ç–∫–∞–ø / –ò–º–ø–æ—Ä—Ç</h2>
            <p>–°–∫–∞—á–∞—Ç—å JSON –±–∞–∑—ã –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –µ—ë –∏–∑ —Ñ–∞–π–ª–∞</p>
          </div>
          <button class="btn small" id="btnResetApp" title="–°–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–û–°–¢–û–†–û–ñ–ù–û)">üß® –°–±—Ä–æ—Å</button>
        </div>
        <div class="cardBody">
          <div class="grid" style="gap:12px;">
            <button class="btn primary" id="btnExport">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å –±—ç–∫–∞–ø JSON</button>

            <div class="item">
              <div class="itemTitle">–ò–º–ø–æ—Ä—Ç</div>
              <div class="itemMeta">–ó–∞–≥—Ä—É–∑–∏—Ç–µ JSON, —á—Ç–æ–±—ã –∑–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.</div>
              <div style="height:8px;"></div>
              <input type="file" id="importFile" accept="application/json,.json" />
              <div style="height:10px;"></div>
              <button class="btn danger" id="btnImport">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å (–∑–∞–º–µ–Ω–∏—Ç—å)</button>
            </div>

            <div class="item">
              <div class="itemTitle">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ single-file PWA</div>
              <div class="itemMeta">
                –ú–∞–Ω–∏—Ñ–µ—Å—Ç –≤—Å—Ç—Ä–æ–µ–Ω, –Ω–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π Service Worker (offline-–∫—ç—à) –æ–±—ã—á–Ω–æ —Ç—Ä–µ–±—É–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –Ω–∞ —Ç–æ–º –∂–µ –¥–æ–º–µ–Ω–µ.
                –ó–¥–µ—Å—å ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –≤ —Ä–∞–º–∫–∞—Ö <b>–æ–¥–Ω–æ–≥–æ</b> HTML.
              </div>
            </div>

          </div>
        </div>
      </section>
    
        </div>

        <div class="segPane" data-seg-pane="about" role="tabpanel" style="display:none;">
          <div class="item">
            <div class="itemTitle">LitRPG Omni-Tool</div>
            <div class="itemMeta">
              Single-file –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∫–Ω–∏–≥/–≥–ª–∞–≤ + —Ä–µ–¥–∞–∫—Ç–æ—Ä + RPG-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä.
              <div style="height:10px;"></div>
              <ul style="margin:0;padding-left:18px;opacity:.9;">
                <li>–ù–∞–≤–∏–≥–∞—Ü–∏—è: bottom nav</li>
                <li>–ü–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –≤–∫–ª–∞–¥–∫–∞–º–∏ —Å –∞–Ω–∏–º–∞—Ü–∏–µ–π</li>
                <li>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</li>
              </ul>
            </div>
          </div>
        </div>
      </section>
</div>

        <nav class="bottomNav" id="nav" aria-label="–û—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è">
      <button class="navBtn" type="button" data-tab="library" aria-label="–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞">
        <span class="ico">üìö</span><span class="lbl">–ë–∏–±–ª–∏–æ</span>
      </button>
      <button class="navBtn" type="button" data-tab="god" aria-label="–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã">
        <span class="ico">üß™</span><span class="lbl">God</span>
      </button>
      <button class="navBtn" type="button" data-tab="hero" aria-label="–ì–µ—Ä–æ–π">
        <span class="ico">üßç</span><span class="lbl">Hero</span>
      </button>
      <button class="navBtn" type="button" data-tab="write" aria-label="–†–µ–¥–∞–∫—Ç–æ—Ä">
        <span class="ico">‚úçÔ∏è</span><span class="lbl">Write</span>
      </button>
      <button class="navBtn" type="button" data-tab="settings" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">
        <span class="ico">‚öôÔ∏è</span><span class="lbl">–ù–∞—Å—Ç—Ä.</span>
      </button>
      <div class="navIndicator" id="navIndicator" aria-hidden="true"></div>
    </nav>
  </div>

  <script>
    /*****************************************************************
     * LitRPG Omni-Tool (Single-file SPA)
     * - localStorage persistence
     * - Library: Books -> Volumes -> Chapters
     * - God Mode: Attributes + Derived formulas
     * - Hero: Level + free points + allocation
     * - Writer IDE: Visual + Code + Insert Status + Voice input
     *****************************************************************/

    // ---------- Error HUD ----------
    const errorHud = document.getElementById('errorHud');
    const errorHudBody = document.getElementById('errorHudBody');
    document.getElementById('errorHudClose').addEventListener('click', () => {
      errorHud.style.display = 'none';
    });

    // ---------- UI prefs (theme + compact) ----------
    const SAFE_STORE = {
      get(key, fallback=null){
        try{
          const v = localStorage.getItem(key);
          return (v===null || v===undefined) ? fallback : v;
        }catch(e){ return fallback; }
      },
      set(key, value){
        try{ localStorage.setItem(key, value); }catch(e){}
      }
    };

    const btnTheme = document.getElementById('btnTheme');
    const btnCompact = document.getElementById('btnCompact');

    function applyTheme(theme){
      const t = (theme === 'light') ? 'light' : 'dark';
      document.documentElement.dataset.theme = t;
      if(btnTheme) btnTheme.textContent = (t === 'light') ? '‚òÄÔ∏è' : 'üåô';
      SAFE_STORE.set('litrpg_theme', t);
    }
    function applyCompact(on){
      const enabled = !!on;
      document.body.classList.toggle('compact', enabled);
      if(btnCompact) btnCompact.textContent = enabled ? '‚ÜïÔ∏è' : '‚ÜîÔ∏è';
      SAFE_STORE.set('litrpg_compact', enabled ? '1' : '0');
    }

    function applyReduceMotion(on){
      const enabled = !!on;
      document.body.classList.toggle('reducedMotion', enabled);
      SAFE_STORE.set('litrpg_reduceMotion', enabled ? '1' : '0');
    }

    function applyFontScale(percent){
      let p = Number(percent);
      if(!Number.isFinite(p)) p = 100;
      p = Math.max(90, Math.min(120, Math.round(p)));
      document.documentElement.style.setProperty('--fontScale', String(p/100));
      SAFE_STORE.set('litrpg_fontScale', String(p));
      const pill = document.getElementById('fontScalePill');
      if(pill) pill.textContent = p + '%';
    }

    function hapticTap(){
      try{
        const enabled = SAFE_STORE.get('litrpg_haptics', '0') === '1';
        if(!enabled) return;
        if(navigator.vibrate) navigator.vibrate(10);
      }catch(_){}
    }

    // Defaults: compact ON, theme from storage
    const savedTheme = SAFE_STORE.get('litrpg_theme', 'dark');
    const savedCompact = SAFE_STORE.get('litrpg_compact', '1');
    applyTheme(savedTheme);
    applyCompact(savedCompact !== '0');
    const savedReduceMotion = SAFE_STORE.get('litrpg_reduceMotion', '0');
    const savedFontScale = SAFE_STORE.get('litrpg_fontScale', '100');
    applyReduceMotion(savedReduceMotion === '1');
    applyFontScale(savedFontScale);


    if(btnTheme){
      btnTheme.addEventListener('click', () => {
        const cur = document.documentElement.dataset.theme || 'dark';
        applyTheme(cur === 'dark' ? 'light' : 'dark');
      });
    }
    if(btnCompact){
      btnCompact.addEventListener('click', () => {
        const on = document.body.classList.contains('compact');
        applyCompact(!on);
      });
    }


    function showError(err, context="") {
      try{
        const msg = [
          context ? `[${context}]` : '',
          (err && err.stack) ? err.stack : String(err)
        ].filter(Boolean).join("\\n");
        errorHudBody.textContent = msg;
        errorHud.style.display = 'block';
      }catch(_){}
      console.error(err);
    }

    window.addEventListener('error', (e) => showError(e.error || e.message, 'window.error'));
    window.addEventListener('unhandledrejection', (e) => showError(e.reason || e, 'unhandledrejection'));

    // ---------- PWA-ish (manifest + icons as data URL) ----------
    (function initPwaMeta(){
      try{
        const iconSvg =
          `<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256" viewBox="0 0 256 256">
             <defs>
               <radialGradient id="g" cx="35%" cy="30%" r="70%">
                 <stop offset="0%" stop-color="#00e5ff" stop-opacity="1"/>
                 <stop offset="55%" stop-color="#b84dff" stop-opacity="0.9"/>
                 <stop offset="100%" stop-color="#ff2fd6" stop-opacity="0.75"/>
               </radialGradient>
             </defs>
             <rect x="18" y="18" width="220" height="220" rx="44" fill="#0a0b12" />
             <rect x="28" y="28" width="200" height="200" rx="38" fill="url(#g)" opacity="0.25" />
             <path d="M68 172V84h32v88H68zm44 0V84h30l26 46V84h30v88h-30l-26-46v46h-30z"
                   fill="#e7e9ff"/>
             <circle cx="204" cy="76" r="10" fill="#39ffb6"/>
           </svg>`;
        const iconData = "data:image/svg+xml;charset=utf-8," + encodeURIComponent(iconSvg);

        document.getElementById('faviconLink').href = iconData;
        document.getElementById('appleIconLink').href = iconData;

        const manifest = {
          name: "LitRPG Omni-Tool",
          short_name: "Omni-Tool",
          start_url: ".",
          scope: ".",
          display: "standalone",
          background_color: "#0a0b12",
          theme_color: "#0a0b12",
          icons: [
            { src: iconData, sizes: "256x256", type: "image/svg+xml", purpose: "any maskable" }
          ]
        };
        const manifestData = "data:application/manifest+json;charset=utf-8," + encodeURIComponent(JSON.stringify(manifest));
        document.getElementById('manifestLink').href = manifestData;
      }catch(err){
        showError(err, "initPwaMeta");
      }
    })();

    // ---------- Storage ----------
    const LS_KEY = "litrpg_omnitool_v1";
    const nowISO = () => new Date().toISOString();
    const uid = () => "id_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16);

    const DEFAULT_BOOK = () => {
      const bookId = uid();
      const volId = uid();
      const chId = uid();
      return {
        id: bookId,
        title: "–ù–æ–≤–∞—è –∫–Ω–∏–≥–∞",
        createdAt: nowISO(),
        updatedAt: nowISO(),
        rpg: {
          attributes: [
            { code:"STR", name:"–°–∏–ª–∞", base: 5 },
            { code:"AGI", name:"–õ–æ–≤–∫–æ—Å—Ç—å", base: 5 },
            { code:"VIT", name:"–ñ–∏–≤—É—á–µ—Å—Ç—å", base: 5 },
            { code:"INT", name:"–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç", base: 5 }
          ],
          derived: [
            { code:"HP", name:"–ó–¥–æ—Ä–æ–≤—å–µ", formula:"(VIT*10)+(STR*2)+(LVL*5)" },
            { code:"MP", name:"–ú–∞–Ω–∞", formula:"(INT*10)+(LVL*3)" }
          ],
          levelConfig: {
            pointsPerLevel: 5
          }
        },
        hero: {
          level: 1,
          freePoints: 0,
          alloc: {} // code -> points
        },
        volumes: [
          {
            id: volId,
            title: "–¢–æ–º 1",
            chapters: [
              {
                id: chId,
                title: "–ì–ª–∞–≤–∞ 1",
                html: "<p>–ü—Ä–∏–≤–µ—Ç! –≠—Ç–æ LitRPG Omni-Tool. –ù–∞–∂–º–∏ <b>üìã –í—Å—Ç–∞–≤–∏—Ç—å –°—Ç–∞—Ç—É—Å</b>, —á—Ç–æ–±—ã –≤—Å—Ç–∞–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å—Ç–∞—Ç–æ–≤ –≤ —Ç–µ–∫—Å—Ç.</p>"
              }
            ]
          }
        ],
        current: { volumeId: volId, chapterId: chId }
      };
    };

    const DEFAULT_STATE = () => {
      const b = DEFAULT_BOOK();
      return {
        version: 1,
        library: { books: [b] },
        currentBookId: b.id,
        ui: { tab: "write", editorMode: "visual", focus: false }
      };
    };

    let state = loadState();

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return DEFAULT_STATE();
        const parsed = JSON.parse(raw);
        // minimal migration guards
        if(!parsed.library || !Array.isArray(parsed.library.books)) return DEFAULT_STATE();
        if(!parsed.currentBookId) parsed.currentBookId = parsed.library.books[0]?.id || DEFAULT_STATE().currentBookId;
        if(!parsed.ui) parsed.ui = { tab:"write", editorMode:"visual", focus:false };
        if(parsed.ui.editorMode !== "visual" && parsed.ui.editorMode !== "code") parsed.ui.editorMode = "visual";
        return parsed;
      }catch(err){
        showError(err, "loadState");
        return DEFAULT_STATE();
      }
    }

    let saveTimer = null;
    function scheduleSave(){
      clearTimeout(saveTimer);
      saveTimer = setTimeout(saveNow, 180);
    }
    function saveNow(){
      try{
        localStorage.setItem(LS_KEY, JSON.stringify(state));
      }catch(err){
        showError(err, "saveNow");
      }
    }

    // ---------- Helpers ----------
    function getCurrentBook(){
      return state.library.books.find(b => b.id === state.currentBookId) || state.library.books[0];
    }
    function setCurrentBook(bookId){
      const b = state.library.books.find(x => x.id === bookId);
      if(!b) return;
      state.currentBookId = bookId;
      // ensure current pointers valid
      if(!b.current || !b.current.volumeId || !b.current.chapterId){
        const v0 = b.volumes[0] || { id: uid(), title:"–¢–æ–º 1", chapters:[] };
        if(!b.volumes.length) b.volumes.push(v0);
        const c0 = v0.chapters[0] || { id: uid(), title:"–ì–ª–∞–≤–∞ 1", html:"" };
        if(!v0.chapters.length) v0.chapters.push(c0);
        b.current = { volumeId: v0.id, chapterId: c0.id };
      }
      state.ui.tab = state.ui.tab || "write";
      scheduleSave();
      renderAll();
    }
    function getCurrentVolume(book){
      const b = book || getCurrentBook();
      return b.volumes.find(v => v.id === b.current.volumeId) || b.volumes[0];
    }
    function getCurrentChapter(book){
      const b = book || getCurrentBook();
      const v = getCurrentVolume(b);
      if(!v) return null;
      return v.chapters.find(c => c.id === b.current.chapterId) || v.chapters[0] || null;
    }

    function clampInt(n, min, max){
      n = Number.isFinite(+n) ? Math.trunc(+n) : 0;
      if(min != null) n = Math.max(min, n);
      if(max != null) n = Math.min(max, n);
      return n;
    }

    function sanitizeCode(code){
      return String(code || "").trim().toUpperCase().replace(/[^A-Z0-9_]/g, "");
    }

    // ---------- Formula Engine (tokenize -> shunting yard -> eval) ----------
    const OPS = {
      "+": { p: 2, assoc: "L", arity: 2 },
      "-": { p: 2, assoc: "L", arity: 2 },
      "*": { p: 3, assoc: "L", arity: 2 },
      "/": { p: 3, assoc: "L", arity: 2 },
      "%": { p: 3, assoc: "L", arity: 2 },
      "^": { p: 4, assoc: "R", arity: 2 },
      "u-": { p: 5, assoc: "R", arity: 1 },
      "u+": { p: 5, assoc: "R", arity: 1 },
    };

    function tokenize(expr){
      const s = String(expr || "").trim();
      const tokens = [];
      let i = 0;
      while(i < s.length){
        const ch = s[i];
        if(/\\s/.test(ch)){ i++; continue; }

        // number
        if(/[0-9.]/.test(ch)){
          let j = i;
          while(j < s.length && /[0-9.]/.test(s[j])) j++;
          const raw = s.slice(i,j);
          if(!/^\\d+(\\.\\d+)?$/.test(raw)) throw new Error(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —á–∏—Å–ª–æ: ${raw}`);
          tokens.push({ t:"num", v: parseFloat(raw) });
          i = j; continue;
        }

        // identifier (attribute code)
        if(/[A-Za-z_]/.test(ch)){
          let j = i;
          while(j < s.length && /[A-Za-z0-9_]/.test(s[j])) j++;
          const id = s.slice(i,j).toUpperCase();
          tokens.push({ t:"id", v: id });
          i = j; continue;
        }

        // operators / parens
        if("+-*/%^()".includes(ch)){
          if(ch === "(" || ch === ")"){
            tokens.push({ t:"par", v: ch });
          }else{
            tokens.push({ t:"op", v: ch });
          }
          i++; continue;
        }

        throw new Error(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–∏–º–≤–æ–ª –≤ —Ñ–æ—Ä–º—É–ª–µ: "${ch}"`);
      }
      return tokens;
    }

    function toRPN(tokens){
      const out = [];
      const stack = [];
      let prev = null;

      for(const tok of tokens){
        if(tok.t === "num" || tok.t === "id"){
          out.push(tok);
          prev = tok;
          continue;
        }

        if(tok.t === "op"){
          let op = tok.v;
          const prevIsValue = prev && (prev.t === "num" || prev.t === "id" || (prev.t === "par" && prev.v === ")"));
          const unary = !prevIsValue; // at start or after operator or after '('
          if(unary && (op === "+" || op === "-")){
            op = (op === "+") ? "u+" : "u-";
          }
          if(!OPS[op]) throw new Error(`–û–ø–µ—Ä–∞—Ç–æ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è: ${op}`);

          while(stack.length){
            const top = stack[stack.length-1];
            if(top.t !== "op") break;
            const o1 = OPS[op], o2 = OPS[top.v];
            if(!o2) break;
            const cond = (o1.assoc === "L" && o1.p <= o2.p) || (o1.assoc === "R" && o1.p < o2.p);
            if(cond) out.push(stack.pop()); else break;
          }
          stack.push({ t:"op", v: op });
          prev = tok;
          continue;
        }

        if(tok.t === "par" && tok.v === "("){
          stack.push(tok);
          prev = tok;
          continue;
        }

        if(tok.t === "par" && tok.v === ")"){
          let found = false;
          while(stack.length){
            const top = stack.pop();
            if(top.t === "par" && top.v === "("){ found = true; break; }
            out.push(top);
          }
          if(!found) throw new Error("–°–∫–æ–±–∫–∏ –Ω–µ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω—ã");
          prev = tok;
          continue;
        }
      }

      while(stack.length){
        const top = stack.pop();
        if(top.t === "par") throw new Error("–°–∫–æ–±–∫–∏ –Ω–µ —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω—ã");
        out.push(top);
      }
      return out;
    }

    function evalRPN(rpn, vars){
      const st = [];
      for(const tok of rpn){
        if(tok.t === "num"){ st.push(tok.v); continue; }
        if(tok.t === "id"){
          if(!(tok.v in vars)) throw new Error(`–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è: ${tok.v}`);
          st.push(vars[tok.v]);
          continue;
        }
        if(tok.t === "op"){
          const op = tok.v;
          const meta = OPS[op];
          if(meta.arity === 1){
            if(st.length < 1) throw new Error("–û—à–∏–±–∫–∞ –≤—ã—Ä–∞–∂–µ–Ω–∏—è (—É–Ω–∞—Ä–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä)");
            const a = st.pop();
            st.push(op === "u-" ? -a : +a);
          }else{
            if(st.length < 2) throw new Error("–û—à–∏–±–∫–∞ –≤—ã—Ä–∞–∂–µ–Ω–∏—è (–±–∏–Ω–∞—Ä–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä)");
            const b = st.pop();
            const a = st.pop();
            let res = 0;
            if(op === "+") res = a + b;
            else if(op === "-") res = a - b;
            else if(op === "*") res = a * b;
            else if(op === "/") res = b === 0 ? NaN : a / b;
            else if(op === "%") res = b === 0 ? NaN : a % b;
            else if(op === "^") res = Math.pow(a, b);
            st.push(res);
          }
          continue;
        }
      }
      if(st.length !== 1) throw new Error("–û—à–∏–±–∫–∞ –≤—ã—Ä–∞–∂–µ–Ω–∏—è (—Å—Ç–µ–∫ –Ω–µ –ø—É—Å—Ç/–Ω–µ 1)");
      const v = st[0];
      if(!Number.isFinite(v)) return v; // allow NaN/Infinity to signal issues
      return v;
    }

    function computeStats(book){
      // base vars: attributes and LVL
      const b = book || getCurrentBook();
      const hero = b.hero;
      const vars = { LVL: hero.level };

      // attributes
      for(const a of b.rpg.attributes){
        const base = Number(a.base) || 0;
        const alloc = Number(hero.alloc?.[a.code] || 0) || 0;
        vars[a.code] = base + alloc;
      }

      // derived: try iterative resolution (allows derived to reference other derived)
      const derivedOut = {};
      const pending = b.rpg.derived.map(d => ({...d}));
      let safety = 0;

      while(pending.length && safety++ < 20){
        let progressed = false;

        for(let i = pending.length - 1; i >= 0; i--){
          const d = pending[i];
          try{
            const rpn = toRPN(tokenize(d.formula));
            const v = evalRPN(rpn, {...vars, ...derivedOut});
            if(Number.isFinite(v)){
              derivedOut[d.code] = v;
              progressed = true;
              pending.splice(i,1);
            }else{
              // NaN/Inf: treat as error; keep pending to report later
            }
          }catch(e){
            // likely missing var; keep pending
          }
        }

        if(!progressed) break;
      }

      // second pass: attempt to compute remaining and keep errors
      const errors = [];
      for(const d of pending){
        try{
          const rpn = toRPN(tokenize(d.formula));
          const v = evalRPN(rpn, {...vars, ...derivedOut});
          derivedOut[d.code] = v;
          if(!Number.isFinite(v)) errors.push(`${d.code}: —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–µ—á–∏—Å–ª–æ–≤–æ–π (${v})`);
        }catch(e){
          errors.push(`${d.code}: ${e.message}`);
        }
      }

      return { vars, derived: derivedOut, errors };
    }

    // ---------- UI refs ----------
    const chipBookTitle = document.getElementById('chipBookTitle');
    const chipChapterTitle = document.getElementById('chipChapterTitle');

    const navButtons = Array.from(document.querySelectorAll('.navBtn'));
    const tabEls = {
      library: document.getElementById('tab-library'),
      god: document.getElementById('tab-god'),
      hero: document.getElementById('tab-hero'),
      write: document.getElementById('tab-write'),
      settings: document.getElementById('tab-settings')
    };

    const bookList = document.getElementById('bookList');
    const treeList = document.getElementById('treeList');

    const attrList = document.getElementById('attrList');
    const derivedList = document.getElementById('derivedList');
    const pointsPerLevel = document.getElementById('pointsPerLevel');
    const recalcHint = document.getElementById('recalcHint');

    const heroLevelPill = document.getElementById('heroLevelPill');
    const heroFreePill = document.getElementById('heroFreePill');
    const heroAttrList = document.getElementById('heroAttrList');
    const heroDerivedList = document.getElementById('heroDerivedList');

    const visualEditor = document.getElementById('visualEditor');
    const codeEditor = document.getElementById('codeEditor');
    const modeVisual = document.getElementById('modeVisual');
    const modeCode = document.getElementById('modeCode');

    // ---------- Tabs ----------
    
    function setTab(tab, opts={}){
      const t = String(tab || "").trim();
      if(!tabEls[t]) return;
      if(state.ui.tab === t) return;

      state.ui.tab = t;
      scheduleSave();
      renderTabs();

      if(opts.pushHash){
        const h = "#"+t;
        if(location.hash !== h) location.hash = h;
      }
    }


    
    const TAB_ORDER = ["library","god","hero","write","settings"];
    let lastTab = null;

    function updateHeaderForTab(tab){
      const brandSub = document.getElementById('brandSub');
      const map = {
        library: "–ö–Ω–∏–≥–∏, —Ç–æ–º–∞ –∏ –≥–ª–∞–≤—ã",
        god: "–ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä—ã, —Ç–∞–±–ª–∏—Ü—ã, –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã",
        hero: "–°—Ç–∞—Ç—ã, –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ, –ø—Ä–æ–≥—Ä–µ—Å—Å",
        write: "–†–µ–¥–∞–∫—Ç–æ—Ä –≥–ª–∞–≤ –∏ –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ç—É—Å",
        settings: "–¢–µ–º–∞, –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∏ –±—ç–∫–∞–ø"
      };
      if(brandSub) brandSub.textContent = map[tab] || "LitRPG Omni-Tool";
    }

    function positionNavIndicator(){
      const ind = document.getElementById('navIndicator');
      if(!ind) return;
      const activeBtn = navButtons.find(b => b.dataset.tab === (state.ui.tab || "write"));
      if(!activeBtn) { ind.style.opacity = "0"; return; }
      const nav = document.getElementById('nav');
      const r = activeBtn.getBoundingClientRect();
      const nr = nav.getBoundingClientRect();
      const center = (r.left - nr.left) + r.width/2;
      // 5 tabs => indicator ‚Äúpulse‚Äù follows center
      ind.style.opacity = "1";
      ind.style.transform = `translateX(${center - (nr.width/2)}px)`;
    }

    function animateSwitch(oldTab, newTab){
      const newEl = tabEls[newTab];
      if(!newEl) return;

      const oldIdx = oldTab ? TAB_ORDER.indexOf(oldTab) : -1;
      const newIdx = TAB_ORDER.indexOf(newTab);
      const forward = (oldIdx !== -1 && newIdx !== -1) ? (newIdx > oldIdx) : true;

      // hide others first to avoid layout jumps in flex column
      for(const k of Object.keys(tabEls)){
        if(k !== newTab) tabEls[k].style.display = "none";
      }

      newEl.style.display = "block";
      newEl.classList.remove("tabAnimInRight","tabAnimInLeft","tabAnimOutLeft","tabAnimOutRight");
      newEl.classList.add(forward ? "tabAnimInRight" : "tabAnimInLeft");
    }

    function renderTabs(){
      const tab = state.ui.tab || "write";
      animateSwitch(lastTab, tab);
      navButtons.forEach(b => {
        const on = (b.dataset.tab === tab);
        b.classList.toggle('active', on);
        b.setAttribute('aria-current', on ? 'page' : 'false');
      });

      updateHeaderForTab(tab);
      positionNavIndicator();

      // when entering write: ensure editor loaded
      if(tab === "write") loadChapterToEditor();
      lastTab = tab;
    }

    navButtons.forEach(btn => {
      btn.addEventListener('click', () => { hapticTap(); setTab(btn.dataset.tab, {pushHash:true}); });
      btn.addEventListener('keydown', (e) => {
        if(e.key === "Enter" || e.key === " ") { e.preventDefault(); hapticTap(); setTab(btn.dataset.tab, {pushHash:true}); }
      });
    });
(btn => {
      btn.addEventListener('click', () => setTab(btn.dataset.tab));
      btn.addEventListener('keydown', (e) => {
        if(e.key === "Enter" || e.key === " ") { e.preventDefault(); setTab(btn.dataset.tab); }
      });
    });

    // ---------- Focus mode ----------
    const appEl = document.getElementById('app');
    document.getElementById('btnFocus').addEventListener('click', () => {
      state.ui.focus = !state.ui.focus;
      scheduleSave();
      applyFocusMode();
    });

    function applyFocusMode(){
      const on = !!state.ui.focus;
      appEl.classList.toggle('focusMode', on);
    }

    // ---------- Books CRUD ----------
    document.getElementById('btnNewBook').addEventListener('click', () => {
      try{
        const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–Ω–∏–≥–∏:", "–ù–æ–≤–∞—è –∫–Ω–∏–≥–∞");
        if(title == null) return;
        const b = DEFAULT_BOOK();
        b.title = title.trim() || "–ù–æ–≤–∞—è –∫–Ω–∏–≥–∞";
        state.library.books.unshift(b);
        state.currentBookId = b.id;
        scheduleSave();
        renderAll();
      }catch(err){ showError(err, "btnNewBook"); }
    });

    document.getElementById('btnRenameBook').addEventListener('click', () => {
      try{
        const b = getCurrentBook();
        const title = prompt("–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É:", b.title);
        if(title == null) return;
        b.title = title.trim() || b.title;
        b.updatedAt = nowISO();
        scheduleSave();
        renderAll();
      }catch(err){ showError(err, "btnRenameBook"); }
    });

    function deleteBook(bookId){
      if(state.library.books.length <= 1){
        alert("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–Ω–∏–≥—É.");
        return;
      }
      const b = state.library.books.find(x => x.id === bookId);
      const ok = confirm(`–£–¥–∞–ª–∏—Ç—å –∫–Ω–∏–≥—É "${b?.title || ""}"? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –µ—ë —Ç–µ–∫—Å—Ç –∏ RPG-—Å–∏—Å—Ç–µ–º—É.`);
      if(!ok) return;
      state.library.books = state.library.books.filter(x => x.id !== bookId);
      if(state.currentBookId === bookId){
        state.currentBookId = state.library.books[0].id;
      }
      scheduleSave();
      renderAll();
    }

    function renderBookList(){
      const cur = getCurrentBook();
      bookList.innerHTML = "";
      state.library.books.forEach(b => {
        const el = document.createElement('div');
        el.className = "item";
        el.innerHTML = `
          <div class="itemTop">
            <div style="min-width:0;">
              <div class="itemTitle">${escapeHTML(b.title)}</div>
              <div class="itemMeta">${b.volumes.length} —Ç–æ–º(–∞), ${countChapters(b)} –≥–ª–∞–≤(—ã)</div>
            </div>
            <div class="row tight" style="gap:8px;">
              <span class="pill">${b.id === cur.id ? "–¢–µ–∫—É—â–∞—è" : "‚Äî"}</span>
              <button class="btn small ${b.id===cur.id ? "primary" : ""}">–û—Ç–∫—Ä—ã—Ç—å</button>
              <button class="btn small danger" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
            </div>
          </div>
        `;
        const btnOpen = el.querySelectorAll('button')[0];
        const btnDel = el.querySelectorAll('button')[1];
        btnOpen.addEventListener('click', () => setCurrentBook(b.id));
        btnDel.addEventListener('click', () => deleteBook(b.id));
        bookList.appendChild(el);
      });
    }

    function countChapters(book){
      return (book.volumes || []).reduce((acc,v) => acc + (v.chapters?.length || 0), 0);
    }

    // ---------- Volumes/Chapters CRUD ----------
    document.getElementById('btnNewVolume').addEventListener('click', () => {
      try{
        const b = getCurrentBook();
        const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–º–∞:", `–¢–æ–º ${b.volumes.length + 1}`);
        if(title == null) return;
        const v = { id: uid(), title: title.trim() || `–¢–æ–º ${b.volumes.length + 1}`, chapters: [] };
        b.volumes.push(v);
        // auto create first chapter
        const c = { id: uid(), title: "–ì–ª–∞–≤–∞ 1", html: "" };
        v.chapters.push(c);
        b.current.volumeId = v.id;
        b.current.chapterId = c.id;
        b.updatedAt = nowISO();
        scheduleSave();
        renderAll();
        setTab("write");
      }catch(err){ showError(err, "btnNewVolume"); }
    });

    document.getElementById('btnNewChapter').addEventListener('click', () => {
      try{
        const b = getCurrentBook();
        const v = getCurrentVolume(b);
        if(!v){
          alert("–ù–µ—Ç —Ç–æ–º–∞. –°–æ–∑–¥–∞–π—Ç–µ —Ç–æ–º —Å–Ω–∞—á–∞–ª–∞.");
          return;
        }
        const title = prompt("–ù–∞–∑–≤–∞–Ω–∏–µ –≥–ª–∞–≤—ã:", `–ì–ª–∞–≤–∞ ${v.chapters.length + 1}`);
        if(title == null) return;
        const c = { id: uid(), title: title.trim() || `–ì–ª–∞–≤–∞ ${v.chapters.length + 1}`, html:"" };
        v.chapters.push(c);
        b.current.volumeId = v.id;
        b.current.chapterId = c.id;
        b.updatedAt = nowISO();
        scheduleSave();
        renderAll();
        setTab("write");
      }catch(err){ showError(err, "btnNewChapter"); }
    });

    function renameVolume(volumeId){
      const b = getCurrentBook();
      const v = b.volumes.find(x => x.id === volumeId);
      if(!v) return;
      const title = prompt("–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ç–æ–º:", v.title);
      if(title == null) return;
      v.title = title.trim() || v.title;
      b.updatedAt = nowISO();
      scheduleSave();
      renderAll();
    }
    function deleteVolume(volumeId){
      const b = getCurrentBook();
      if(b.volumes.length <= 1){
        alert("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–æ–º.");
        return;
      }
      const v = b.volumes.find(x => x.id === volumeId);
      const ok = confirm(`–£–¥–∞–ª–∏—Ç—å —Ç–æ–º "${v?.title || ""}" –∏ –≤—Å–µ –µ–≥–æ –≥–ª–∞–≤—ã?`);
      if(!ok) return;
      b.volumes = b.volumes.filter(x => x.id !== volumeId);
      if(b.current.volumeId === volumeId){
        const v0 = b.volumes[0];
        const c0 = v0.chapters[0] || { id: uid(), title:"–ì–ª–∞–≤–∞ 1", html:"" };
        if(!v0.chapters.length) v0.chapters.push(c0);
        b.current.volumeId = v0.id;
        b.current.chapterId = c0.id;
      }
      b.updatedAt = nowISO();
      scheduleSave();
      renderAll();
    }

    function renameChapter(chapterId){
      const b = getCurrentBook();
      const v = getCurrentVolume(b);
      const c = v?.chapters.find(x => x.id === chapterId);
      if(!c) return;
      const title = prompt("–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –≥–ª–∞–≤—É:", c.title);
      if(title == null) return;
      c.title = title.trim() || c.title;
      b.updatedAt = nowISO();
      scheduleSave();
      renderAll();
    }
    function deleteChapter(chapterId){
      const b = getCurrentBook();
      const v = getCurrentVolume(b);
      if(!v) return;
      if(v.chapters.length <= 1 && b.volumes.length <= 1){
        alert("–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω—é—é –≥–ª–∞–≤—É (–≤ –∫–Ω–∏–≥–µ –¥–æ–ª–∂–µ–Ω –æ—Å—Ç–∞—Ç—å—Å—è —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç).");
        return;
      }
      if(v.chapters.length <= 1 && b.volumes.length > 1){
        const ok2 = confirm("–í —ç—Ç–æ–º —Ç–æ–º–µ –ø–æ—Å–ª–µ–¥–Ω—è—è –≥–ª–∞–≤–∞. –£–¥–∞–ª–∏—Ç—å –≤–µ—Å—å —Ç–æ–º?");
        if(!ok2) return;
        deleteVolume(v.id);
        return;
      }
      const c = v.chapters.find(x => x.id === chapterId);
      const ok = confirm(`–£–¥–∞–ª–∏—Ç—å –≥–ª–∞–≤—É "${c?.title || ""}"?`);
      if(!ok) return;

      v.chapters = v.chapters.filter(x => x.id !== chapterId);
      if(b.current.chapterId === chapterId){
        const c0 = v.chapters[0];
        b.current.chapterId = c0.id;
      }
      b.updatedAt = nowISO();
      scheduleSave();
      renderAll();
    }

    function selectChapter(volumeId, chapterId){
      const b = getCurrentBook();
      b.current.volumeId = volumeId;
      b.current.chapterId = chapterId;
      b.updatedAt = nowISO();
      scheduleSave();
      renderAll();
      setTab("write");
    }

    function renderTree(){
      const b = getCurrentBook();
      treeList.innerHTML = "";
      b.volumes.forEach(v => {
        const volWrap = document.createElement('div');
        volWrap.className = "item";
        volWrap.innerHTML = `
          <div class="itemTop">
            <div style="min-width:0;">
              <div class="itemTitle">${escapeHTML(v.title)}</div>
              <div class="itemMeta">${v.chapters.length} –≥–ª–∞–≤(—ã)</div>
            </div>
            <div class="row tight" style="gap:8px;">
              <button class="btn small">‚úèÔ∏è</button>
              <button class="btn small danger">üóëÔ∏è</button>
            </div>
          </div>
          <div class="list" style="margin-top:8px;gap:8px;" data-vol="${v.id}"></div>
        `;
        const btnRen = volWrap.querySelectorAll('button')[0];
        const btnDel = volWrap.querySelectorAll('button')[1];
        btnRen.addEventListener('click', () => renameVolume(v.id));
        btnDel.addEventListener('click', () => deleteVolume(v.id));

        const chapList = volWrap.querySelector('[data-vol]');
        v.chapters.forEach(c => {
          const chapEl = document.createElement('div');
          chapEl.className = "item";
          const isCur = (b.current.volumeId === v.id && b.current.chapterId === c.id);
          chapEl.style.borderColor = isCur ? "rgba(0,229,255,.45)" : "rgba(30,33,64,.9)";
          chapEl.innerHTML = `
            <div class="itemTop">
              <div style="min-width:0;">
                <div class="itemTitle">${escapeHTML(c.title)}</div>
                <div class="itemMeta">${isCur ? "–¢–µ–∫—É—â–∞—è –≥–ª–∞–≤–∞" : "‚Äî"}</div>
              </div>
              <div class="row tight" style="gap:8px;">
                <button class="btn small ${isCur ? "primary" : ""}">–û—Ç–∫—Ä—ã—Ç—å</button>
                <button class="btn small">‚úèÔ∏è</button>
                <button class="btn small danger">üóëÔ∏è</button>
              </div>
            </div>
          `;
          const [openBtn, renBtn, delBtn] = chapEl.querySelectorAll('button');
          openBtn.addEventListener('click', () => selectChapter(v.id, c.id));
          renBtn.addEventListener('click', () => renameChapter(c.id));
          delBtn.addEventListener('click', () => deleteChapter(c.id));
          chapList.appendChild(chapEl);
        });

        treeList.appendChild(volWrap);
      });
    }

    // ---------- God Mode: Attributes ----------
    document.getElementById('btnAddAttr').addEventListener('click', () => {
      try{
        const b = getCurrentBook();
        const code = sanitizeCode(prompt("–ö–æ–¥ –∞—Ç—Ä–∏–±—É—Ç–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä STR):", "STR"));
        if(!code) return;
        if(code === "LVL"){
          alert("LVL –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω (—É—Ä–æ–≤–µ–Ω—å –≥–µ—Ä–æ—è). –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –∫–æ–¥.");
          return;
        }
        if(b.rpg.attributes.some(a => a.code === code)){
          alert("–ê—Ç—Ä–∏–±—É—Ç —Å —Ç–∞–∫–∏–º –∫–æ–¥–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.");
          return;
        }
        const name = (prompt("–ò–º—è –∞—Ç—Ä–∏–±—É—Ç–∞:", code) || code).trim() || code;
        const base = clampInt(prompt("–ë–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ:", "5"), -999999, 999999);
        b.rpg.attributes.push({ code, name, base });
        // init hero alloc if needed
        if(!b.hero.alloc) b.hero.alloc = {};
        b.hero.alloc[code] = b.hero.alloc[code] || 0;
        b.updatedAt = nowISO();
        scheduleSave();
        renderAll();
      }catch(err){ showError(err, "btnAddAttr"); }
    });

    function deleteAttr(code){
      const b = getCurrentBook();
      const ok = confirm(`–£–¥–∞–ª–∏—Ç—å –∞—Ç—Ä–∏–±—É—Ç ${code}? –û–Ω –∏—Å—á–µ–∑–Ω–µ—Ç –∏–∑ —Å–∏—Å—Ç–µ–º—ã –∏ –≥–µ—Ä–æ—è.`);
      if(!ok) return;
      b.rpg.attributes = b.rpg.attributes.filter(a => a.code !== code);
      if(b.hero.alloc && code in b.hero.alloc) delete b.hero.alloc[code];
      b.updatedAt = nowISO();
      scheduleSave();
      renderAll();
    }

    function renderAttrs(){
      const b = getCurrentBook();
      attrList.innerHTML = "";
      b.rpg.attributes.forEach(a => {
        const el = document.createElement('div');
        el.className = "item";
        el.innerHTML = `
          <div class="grid two">
            <div>
              <div class="label">–ö–æ–¥</div>
              <input value="${escapeAttr(a.code)}" data-k="code" />
            </div>
            <div>
              <div class="label">–ò–º—è</div>
              <input value="${escapeAttr(a.name)}" data-k="name" />
            </div>
          </div>
          <div class="grid two">
            <div>
              <div class="label">–ë–∞–∑–∞</div>
              <input type="number" value="${escapeAttr(a.base)}" data-k="base" />
            </div>
            <div class="row tight" style="gap:8px;align-items:end;">
              <button class="btn small danger" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
        `;
        const inputs = el.querySelectorAll('input');
        const btnDel = el.querySelector('button');

        inputs.forEach(inp => {
          inp.addEventListener('input', () => {
            try{
              if(inp.dataset.k === "code"){
                const newCode = sanitizeCode(inp.value);
                inp.value = newCode;
                if(!newCode) return;
                if(newCode === "LVL"){
                  showToast("LVL –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω.");
                  inp.value = a.code;
                  return;
                }
                // prevent duplicates
                if(b.rpg.attributes.some(x => x !== a && x.code === newCode)){
                  showToast("–¢–∞–∫–æ–π –∫–æ–¥ —É–∂–µ –µ—Å—Ç—å.");
                  inp.value = a.code;
                  return;
                }
                // update hero alloc key
                const old = a.code;
                if(old !== newCode){
                  a.code = newCode;
                  if(!b.hero.alloc) b.hero.alloc = {};
                  b.hero.alloc[newCode] = b.hero.alloc[old] || 0;
                  delete b.hero.alloc[old];
                  // also update formulas? we won't auto-rewrite; user can adjust.
                }
              }
              if(inp.dataset.k === "name"){
                a.name = inp.value.trim() || a.name;
              }
              if(inp.dataset.k === "base"){
                a.base = clampInt(inp.value, -999999, 999999);
              }
              b.updatedAt = nowISO();
              scheduleSave();
              renderHero(); // update live
            }catch(err){ showError(err, "attr input"); }
          });
        });

        btnDel.addEventListener('click', () => deleteAttr(a.code));
        attrList.appendChild(el);
      });
    }

    // ---------- God Mode: Derived ----------
    document.getElementById('btnAddDerived').addEventListener('click', () => {
      try{
        const b = getCurrentBook();
        const code = sanitizeCode(prompt("–ö–æ–¥ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–æ–π (–Ω–∞–ø—Ä–∏–º–µ—Ä HP):", "HP"));
        if(!code) return;
        if(code === "LVL"){
          alert("LVL –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω. –í—ã–±–µ—Ä–∏—Ç–µ –¥—Ä—É–≥–æ–π –∫–æ–¥.");
          return;
        }
        if(b.rpg.derived.some(d => d.code === code) || b.rpg.attributes.some(a => a.code === code)){
          alert("–ö–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è (–∞—Ç—Ä–∏–±—É—Ç–æ–º –∏–ª–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–æ–π).");
          return;
        }
        const name = (prompt("–ò–º—è –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–æ–π:", code) || code).trim() || code;
        const formula = (prompt("–§–æ—Ä–º—É–ª–∞:", "(LVL*5)") || "").trim();
        if(!formula) return;
        b.rpg.derived.push({ code, name, formula });
        b.updatedAt = nowISO();
        scheduleSave();
        renderAll();
      }catch(err){ showError(err, "btnAddDerived"); }
    });

    function deleteDerived(code){
      const b = getCurrentBook();
      const ok = confirm(`–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ä–º—É–ª—É ${code}?`);
      if(!ok) return;
      b.rpg.derived = b.rpg.derived.filter(d => d.code !== code);
      b.updatedAt = nowISO();
      scheduleSave();
      renderAll();
    }

    function renderDerived(){
      const b = getCurrentBook();
      derivedList.innerHTML = "";
      b.rpg.derived.forEach(d => {
        const el = document.createElement('div');
        el.className = "item";
        el.innerHTML = `
          <div class="grid two">
            <div>
              <div class="label">–ö–æ–¥</div>
              <input value="${escapeAttr(d.code)}" data-k="code" />
            </div>
            <div>
              <div class="label">–ò–º—è</div>
              <input value="${escapeAttr(d.name)}" data-k="name" />
            </div>
          </div>
          <div>
            <div class="label">–§–æ—Ä–º—É–ª–∞</div>
            <input value="${escapeAttr(d.formula)}" data-k="formula" placeholder="(VIT*10)+(STR*2)+(LVL*5)" />
          </div>
          <div class="row tight" style="gap:8px;align-items:end;">
            <button class="btn small" data-act="test">üß† –¢–µ—Å—Ç</button>
            <button class="btn small danger" data-act="del">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
        const inputs = el.querySelectorAll('input');
        const btnTest = el.querySelector('[data-act="test"]');
        const btnDel = el.querySelector('[data-act="del"]');

        inputs.forEach(inp => {
          inp.addEventListener('input', () => {
            try{
              if(inp.dataset.k === "code"){
                const newCode = sanitizeCode(inp.value);
                inp.value = newCode;
                if(!newCode) return;
                if(newCode === "LVL"){
                  showToast("LVL –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω.");
                  inp.value = d.code;
                  return;
                }
                if(b.rpg.derived.some(x => x !== d && x.code === newCode) || b.rpg.attributes.some(a => a.code === newCode)){
                  showToast("–ö–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.");
                  inp.value = d.code;
                  return;
                }
                d.code = newCode;
              }
              if(inp.dataset.k === "name"){
                d.name = inp.value.trim() || d.name;
              }
              if(inp.dataset.k === "formula"){
                d.formula = inp.value.trim();
              }
              b.updatedAt = nowISO();
              scheduleSave();
              renderHero(); // live recompute
            }catch(err){ showError(err, "derived input"); }
          });
        });

        btnTest.addEventListener('click', () => {
          try{
            const stats = computeStats(getCurrentBook());
            const v = stats.derived[d.code];
            const details = stats.errors.length ? ("\\n–û—à–∏–±–∫–∏:\\n- " + stats.errors.join("\\n- ")) : "";
            alert(`${d.code} = ${formatNum(v)}\\n–§–æ—Ä–º—É–ª–∞: ${d.formula}${details}`);
          }catch(err){ showError(err, "test formula"); }
        });
        btnDel.addEventListener('click', () => deleteDerived(d.code));

        derivedList.appendChild(el);
      });

      pointsPerLevel.value = clampInt(b.rpg.levelConfig?.pointsPerLevel ?? 5, 0, 9999);
    }

    pointsPerLevel.addEventListener('input', () => {
      try{
        const b = getCurrentBook();
        if(!b.rpg.levelConfig) b.rpg.levelConfig = { pointsPerLevel: 5 };
        b.rpg.levelConfig.pointsPerLevel = clampInt(pointsPerLevel.value, 0, 9999);
        b.updatedAt = nowISO();
        scheduleSave();
      }catch(err){ showError(err, "pointsPerLevel"); }
    });

    document.getElementById('btnRecalcNow').addEventListener('click', () => {
      try{
        const b = getCurrentBook();
        const stats = computeStats(b);
        recalcHint.textContent = stats.errors.length
          ? ("‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã –≤ —Ñ–æ—Ä–º—É–ª–∞—Ö:\\n- " + stats.errors.join("\\n- "))
          : "‚úÖ –§–æ—Ä–º—É–ª—ã –≤—ã–≥–ª—è–¥—è—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. (–ï—Å–ª–∏ –≥–¥–µ-—Ç–æ NaN ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–µ–ª–µ–Ω–∏–µ –Ω–∞ –Ω–æ–ª—å / –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.)";
        renderHero();
      }catch(err){ showError(err, "btnRecalcNow"); }
    });

    document.getElementById('btnSeedExample').addEventListener('click', () => {
      try{
        const b = getCurrentBook();
        // seed if empty-ish
        b.rpg.attributes = [
          { code:"STR", name:"–°–∏–ª–∞", base: 5 },
          { code:"AGI", name:"–õ–æ–≤–∫–æ—Å—Ç—å", base: 5 },
          { code:"VIT", name:"–ñ–∏–≤—É—á–µ—Å—Ç—å", base: 5 },
          { code:"INT", name:"–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç", base: 5 }
        ];
        b.rpg.derived = [
          { code:"HP", name:"–ó–¥–æ—Ä–æ–≤—å–µ", formula:"(VIT*10)+(STR*2)+(LVL*5)" },
          { code:"MP", name:"–ú–∞–Ω–∞", formula:"(INT*10)+(LVL*3)" },
          { code:"ATK", name:"–ê—Ç–∞–∫–∞", formula:"(STR*2)+(AGI*1.2)+(LVL*1)" }
        ];
        b.rpg.levelConfig.pointsPerLevel = 5;
        // keep alloc keys consistent
        if(!b.hero.alloc) b.hero.alloc = {};
        for(const a of b.rpg.attributes){
          b.hero.alloc[a.code] = b.hero.alloc[a.code] || 0;
        }
        b.updatedAt = nowISO();
        scheduleSave();
        renderAll();
        showToast("–ü—Ä–∏–º–µ—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω ‚ú®");
      }catch(err){ showError(err, "btnSeedExample"); }
    });

    // ---------- Hero ----------
    document.getElementById('btnLevelUp').addEventListener('click', () => {
      try{
        const b = getCurrentBook();
        const p = clampInt(b.rpg.levelConfig?.pointsPerLevel ?? 5, 0, 999999);
        b.hero.level = clampInt(b.hero.level + 1, 1, 999999);
        b.hero.freePoints = clampInt(b.hero.freePoints + p, 0, 999999);
        b.updatedAt = nowISO();
        scheduleSave();
        renderHero();
        showToast(`Level Up! +${p} –æ—á–∫–æ–≤`);
      }catch(err){ showError(err, "btnLevelUp"); }
    });

    document.getElementById('btnResetAlloc').addEventListener('click', () => {
      try{
        const b = getCurrentBook();
        const ok = confirm("–°–±—Ä–æ—Å–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–µ –æ—á–∫–∏ –∞—Ç—Ä–∏–±—É—Ç–æ–≤? –û—á–∫–∏ –≤–µ—Ä–Ω—É—Ç—Å—è –≤ —Å–≤–æ–±–æ–¥–Ω—ã–µ.");
        if(!ok) return;
        let refunded = 0;
        for(const k of Object.keys(b.hero.alloc || {})){
          refunded += clampInt(b.hero.alloc[k], 0, 999999);
          b.hero.alloc[k] = 0;
        }
        b.hero.freePoints = clampInt(b.hero.freePoints + refunded, 0, 999999);
        b.updatedAt = nowISO();
        scheduleSave();
        renderHero();
      }catch(err){ showError(err, "btnResetAlloc"); }
    });

    function renderHero(){
      const b = getCurrentBook();
      // ensure alloc keys exist
      if(!b.hero.alloc) b.hero.alloc = {};
      for(const a of b.rpg.attributes){
        b.hero.alloc[a.code] = clampInt(b.hero.alloc[a.code] ?? 0, 0, 999999);
      }

      const stats = computeStats(b);

      heroLevelPill.textContent = String(b.hero.level);
      heroFreePill.textContent = String(b.hero.freePoints);

      // Attr list with +/- buttons
      heroAttrList.innerHTML = "";
      b.rpg.attributes.forEach(a => {
        const alloc = clampInt(b.hero.alloc[a.code] || 0, 0, 999999);
        const total = (Number(a.base)||0) + alloc;

        const el = document.createElement('div');
        el.className = "item";
        el.innerHTML = `
          <div class="itemTop">
            <div style="min-width:0;">
              <div class="itemTitle">${escapeHTML(a.name)} <span class="pill">${escapeHTML(a.code)}</span></div>
              <div class="itemMeta">–ë–∞–∑–∞: ${escapeHTML(a.base)} ¬∑ –í–ª–æ–∂–µ–Ω–æ: ${alloc}</div>
            </div>
            <div class="row tight" style="gap:8px;">
              <button class="btn small" data-act="minus">‚àí</button>
              <span class="pill" style="min-width:54px;text-align:center;">${formatNum(total)}</span>
              <button class="btn small primary" data-act="plus">+</button>
            </div>
          </div>
        `;
        const minus = el.querySelector('[data-act="minus"]');
        const plus = el.querySelector('[data-act="plus"]');
        minus.addEventListener('click', () => {
          try{
            if((b.hero.alloc[a.code]||0) <= 0) return;
            b.hero.alloc[a.code] = clampInt(b.hero.alloc[a.code]-1, 0, 999999);
            b.hero.freePoints = clampInt(b.hero.freePoints + 1, 0, 999999);
            b.updatedAt = nowISO();
            scheduleSave();
            renderHero();
          }catch(err){ showError(err, "hero minus"); }
        });
        plus.addEventListener('click', () => {
          try{
            if(b.hero.freePoints <= 0) { showToast("–ù–µ—Ç —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ—á–∫–æ–≤"); return; }
            b.hero.alloc[a.code] = clampInt((b.hero.alloc[a.code]||0)+1, 0, 999999);
            b.hero.freePoints = clampInt(b.hero.freePoints - 1, 0, 999999);
            b.updatedAt = nowISO();
            scheduleSave();
            renderHero();
          }catch(err){ showError(err, "hero plus"); }
        });

        heroAttrList.appendChild(el);
      });

      // Derived list
      heroDerivedList.innerHTML = "";
      b.rpg.derived.forEach(d => {
        const v = stats.derived[d.code];
        const el = document.createElement('div');
        el.className = "item";
        el.innerHTML = `
          <div class="itemTop">
            <div style="min-width:0;">
              <div class="itemTitle">${escapeHTML(d.name)} <span class="pill">${escapeHTML(d.code)}</span></div>
              <div class="itemMeta"><span class="muted">–§–æ—Ä–º—É–ª–∞:</span> <span style="font-family:var(--mono)">${escapeHTML(d.formula)}</span></div>
            </div>
            <span class="pill" style="font-family:var(--mono);">${formatNum(v)}</span>
          </div>
        `;
        heroDerivedList.appendChild(el);
      });

      if(stats.errors.length){
        recalcHint.textContent = "‚ö†Ô∏è –§–æ—Ä–º—É–ª—ã: " + stats.errors.join(" ¬∑ ");
      }else{
        recalcHint.textContent = "";
      }

      // update chip
      updateTopChip();
    }

    // ---------- Writer IDE ----------
    function loadChapterToEditor(){
      const b = getCurrentBook();
      const c = getCurrentChapter(b);
      if(!c) return;

      if(state.ui.editorMode === "visual"){
        visualEditor.innerHTML = c.html || "";
      }else{
        codeEditor.value = c.html || "";
      }
      updateTopChip();
    }

    function persistEditorToChapter(){
      const b = getCurrentBook();
      const c = getCurrentChapter(b);
      if(!c) return;
      if(state.ui.editorMode === "visual"){
        c.html = visualEditor.innerHTML;
      }else{
        c.html = codeEditor.value;
      }
      b.updatedAt = nowISO();
      scheduleSave();
      updateTopChip();
    }

    let editorSaveDebounce = null;
    function scheduleEditorPersist(){
      clearTimeout(editorSaveDebounce);
      editorSaveDebounce = setTimeout(() => {
        try{ persistEditorToChapter(); }catch(err){ showError(err, "scheduleEditorPersist"); }
      }, 220);
    }

    visualEditor.addEventListener('input', scheduleEditorPersist);
    codeEditor.addEventListener('input', scheduleEditorPersist);

    // Editor mode switching
    function setEditorMode(mode){
      const prev = state.ui.editorMode;
      if(mode === prev) return;
      // sync content between modes
      if(prev === "visual"){
        codeEditor.value = visualEditor.innerHTML;
      }else{
        visualEditor.innerHTML = codeEditor.value;
      }
      state.ui.editorMode = mode;
      scheduleSave();
      applyEditorMode();
      scheduleEditorPersist();
    }

    function applyEditorMode(){
      const m = state.ui.editorMode;
      const isVisual = m === "visual";
      modeVisual.classList.toggle('active', isVisual);
      modeCode.classList.toggle('active', !isVisual);
      visualEditor.style.display = isVisual ? "block" : "none";
      codeEditor.style.display = isVisual ? "none" : "block";
    }

    modeVisual.addEventListener('click', () => setEditorMode("visual"));
    modeCode.addEventListener('click', () => setEditorMode("code"));

    // Formatting buttons (Visual only)
    document.getElementById('btnBold').addEventListener('click', () => {
      try{
        if(state.ui.editorMode !== "visual") return showToast("–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ Visual");
        document.execCommand('bold');
        visualEditor.focus();
        scheduleEditorPersist();
      }catch(err){ showError(err, "bold"); }
    });

    document.getElementById('btnItalic').addEventListener('click', () => {
      try{
        if(state.ui.editorMode !== "visual") return showToast("–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –≤ Visual");
        document.execCommand('italic');
        visualEditor.focus();
        scheduleEditorPersist();
      }catch(err){ showError(err, "italic"); }
    });

    document.getElementById('txtColor').addEventListener('input', (e) => {
      try{
        if(state.ui.editorMode !== "visual") return;
        document.execCommand('foreColor', false, e.target.value);
        visualEditor.focus();
        scheduleEditorPersist();
      }catch(err){ showError(err, "color"); }
    });

    // Insert status table
    
    function buildStatusPlainHTML(){
      const b = getCurrentBook();
      const stats = computeStats(b);

      // –ü—Ä–æ—Å—Ç–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞ (–ø–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å–∞–π—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã—Ä–µ–∑–∞—é—Ç —Ç–∞–±–ª–∏—Ü—ã/–∫–ª–∞—Å—Å—ã).
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ–ª—å–∫–æ <p>, <b>, <br>, <hr>.
      const linesAttr = b.rpg.attributes.map(a => {
        const val = stats.vars[a.code];
        return `${escapeHTML(a.code)} (${escapeHTML(a.name)}): ${escapeHTML(formatNum(val))}`;
      }).join("<br>");

      const linesDer = b.rpg.derived.map(d => {
        const val = stats.derived[d.code];
        return `${escapeHTML(d.code)} (${escapeHTML(d.name)}): ${escapeHTML(formatNum(val))}`;
      }).join("<br>");

      const errLine = stats.errors.length
        ? `<p><b>–í–Ω–∏–º–∞–Ω–∏–µ:</b> ${escapeHTML(stats.errors.join(" ¬∑ "))}</p>`
        : "";

      const html = `
        <p><b>–°–¢–ê–¢–£–° –ü–ï–†–°–û–ù–ê–ñ–ê (LVL ${escapeHTML(String(b.hero.level))})</b></p>
        <p><b>–ê—Ç—Ä–∏–±—É—Ç—ã</b><br>${linesAttr || "‚Äî"}</p>
        <p><b>–ü—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ</b><br>${linesDer || "‚Äî"}</p>
        ${errLine}
        <hr>
      `;
      return html.trim();
    }
function insertHTMLAtCursor(html){
      if(state.ui.editorMode === "visual"){
        visualEditor.focus();
        // execCommand insertHTML
        document.execCommand('insertHTML', false, html);
        scheduleEditorPersist();
      }else{
        const ta = codeEditor;
        const start = ta.selectionStart ?? ta.value.length;
        const end = ta.selectionEnd ?? ta.value.length;
        ta.value = ta.value.slice(0, start) + html + ta.value.slice(end);
        const pos = start + html.length;
        ta.selectionStart = ta.selectionEnd = pos;
        ta.focus();
        scheduleEditorPersist();
      }
    }

    function insertStatus(){
      try{
        const html = buildStatusPlainHTML();
        insertHTMLAtCursor(html);
        showToast("–°—Ç–∞—Ç—É—Å –≤—Å—Ç–∞–≤–ª–µ–Ω üìã");
      }catch(err){
        showError(err, "insertStatus");
      }
    }

    document.getElementById('btnInsertStatus').addEventListener('click', insertStatus);
    document.getElementById('btnQuickStatus').addEventListener('click', () => {
      if(state.ui.tab !== "write") setTab("write");
      // after switching, insert after a tick so editor exists
      setTimeout(insertStatus, 40);
    });
    document.getElementById('btnInsertStatusFromHero').addEventListener('click', () => {
      setTab("write");
      setTimeout(insertStatus, 40);
    });

    // Save now / clear
    document.getElementById('btnSaveNow').addEventListener('click', () => {
      try{
        persistEditorToChapter();
        saveNow();
        showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ üíæ");
      }catch(err){ showError(err, "btnSaveNow"); }
    });

    document.getElementById('btnClearChapter').addEventListener('click', () => {
      try{
        const ok = confirm("–û—á–∏—Å—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç —Ç–µ–∫—É—â–µ–π –≥–ª–∞–≤—ã?");
        if(!ok) return;
        if(state.ui.editorMode === "visual") visualEditor.innerHTML = "";
        else codeEditor.value = "";
        scheduleEditorPersist();
      }catch(err){ showError(err, "btnClearChapter"); }
    });

    document.getElementById('btnRenameChapter').addEventListener('click', () => {
      try{
        const c = getCurrentChapter(getCurrentBook());
        if(!c) return;
        renameChapter(c.id);
      }catch(err){ showError(err, "btnRenameChapter"); }
    });
    document.getElementById('btnDeleteChapter').addEventListener('click', () => {
      try{
        const c = getCurrentChapter(getCurrentBook());
        if(!c) return;
        deleteChapter(c.id);
      }catch(err){ showError(err, "btnDeleteChapter"); }
    });

    // Help
    document.getElementById('btnHelp').addEventListener('click', () => {
      alert(
`–ü–∞–º—è—Ç–∫–∞:
‚Ä¢ Visual ‚Äî –æ–±—ã—á–Ω–æ–µ –ø–∏—Å—å–º–æ, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (B/I/—Ü–≤–µ—Ç), –≤—Å—Ç–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –∫–∞–∫ HTML —Ç–∞–±–ª–∏—Ü—ã.
‚Ä¢ Code ‚Äî –ø—Ä—è–º–æ–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ HTML.
‚Ä¢ LVL –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Ñ–æ—Ä–º—É–ª–∞—Ö –∫–∞–∫ —É—Ä–æ–≤–µ–Ω—å –≥–µ—Ä–æ—è.
‚Ä¢ –í—Å—Ç–∞–≤–∫–∞ —Å—Ç–∞—Ç—É—Å–∞: üìã
‚Ä¢ –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ.

–ì–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥:
‚Ä¢ –¢—Ä–µ–±—É–µ—Ç—Å—è HTTPS (–∏–ª–∏ localhost). file:// –æ–±—ã—á–Ω–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω.
‚Ä¢ –ù–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–∏–∫—Ç–æ–≤–∫—É –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã (–º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ) –∫–∞–∫ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç.

–ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º—É–ª—ã:
HP = (VIT*10)+(STR*2)+(LVL*5)`
      );
    });

    // ---------- Voice input (Web Speech API) ----------
    let recognition = null;
    let recognizing = false;
    const micBadge = document.getElementById('micBadge');

    function initSpeech(){
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if(!SR) return null;

      const r = new SR();
      r.continuous = true;
      r.interimResults = true;
      r.lang = "ru-RU";
      return r;
    }

    function setMicUI(on){
      micBadge.style.display = on ? "inline-flex" : "none";
      document.getElementById('btnMic').classList.toggle('primary', on);
    }

    
    
    async function ensureMicPermission(){
      // –ù–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö –∑–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø–æ—è–≤–ª—è–µ—Ç—Å—è –¢–û–õ–¨–ö–û –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ (HTTPS/localhost)
      // –∏ —Ç–æ–ª—å–∫–æ –ø–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–º—É –¥–µ–π—Å—Ç–≤–∏—é (–∫–ª–∏–∫).
      try{
        if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){
          showToast("getUserMedia –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
          return false;
        }

        // –í–ê–ñ–ù–û: file:// –∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ WebView —Å—á–∏—Ç–∞—é—Ç—Å—è –ù–ï–±–µ–∑–æ–ø–∞—Å–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º ‚Äî –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –ø–æ–ø—Ä–æ—Å–∏—Ç—å.
        if(!window.isSecureContext){
          alert(
`–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–ø—Ä–æ—à–µ–Ω, –ø–æ—Ç–æ–º—É —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –æ—Ç–∫—Ä—ã—Ç–∞ –ù–ï –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ.

–ß—Ç–æ –¥–µ–ª–∞—Ç—å:
‚Ä¢ –û—Ç–∫—Ä–æ–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ HTTPS (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ —Ö–æ—Å—Ç–∏–Ω–≥) –∏–ª–∏ —á–µ—Ä–µ–∑ http://localhost.
‚Ä¢ –í Chrome: –º–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PWA —Å HTTPS, —Ç–æ–≥–¥–∞ –º–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç—Å—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ.

–¢–µ–∫—É—â–µ–µ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏–µ: ${location.origin || "(unknown)"}`
          );
          return false;
        }

        // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—Ä–æ—Å–∏—Ç—å –∞—É–¥–∏–æ ‚Äî —ç—Ç–æ –∏ –µ—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–π —Ç—Ä–∏–≥–≥–µ—Ä —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        stream.getTracks().forEach(t => t.stop()); // —Å—Ä–∞–∑—É –æ—Å–≤–æ–±–æ–∂–¥–∞–µ–º
        return true;
      }catch(err){
        const name = err?.name || "";
        const msg = err?.message || String(err);

        // –°–∞–º—ã–µ —á–∞—Å—Ç—ã–µ –∫–µ–π—Å—ã:
        // ‚Ä¢ NotAllowedError: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ø—Ä–µ—Ç–∏–ª –∏–ª–∏ –ø–æ–ª–∏—Ç–∏–∫–∞/–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–ø—Ä–µ—Ç–∏–ª–∏
        // ‚Ä¢ NotFoundError: –Ω–µ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        // ‚Ä¢ SecurityError: –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç/–ø–æ–ª–∏—Ç–∏–∫–∞
        if(name === "NotAllowedError" || name === "PermissionDeniedError"){
          alert(
`–ë—Ä–∞—É–∑–µ—Ä –Ω–µ –¥–∞–ª –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É.

–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
‚Ä¢ –í –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ (–∑–Ω–∞—á–æ–∫ üîí) ‚Üí –†–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–∞–π—Ç–∞ ‚Üí –ú–∏–∫—Ä–æ—Ñ–æ–Ω ‚Üí –†–∞–∑—Ä–µ—à–∏—Ç—å.
‚Ä¢ –í –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞: –†–∞–∑—Ä–µ—à–µ–Ω–∏—è —Å–∞–π—Ç–æ–≤ ‚Üí –ú–∏–∫—Ä–æ—Ñ–æ–Ω.
‚Ä¢ –ï—Å–ª–∏ —Ä–∞–Ω—å—à–µ –Ω–∞–∂–∞–ª–∏ "–ó–∞–ø—Ä–µ—Ç–∏—Ç—å", —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–æ–≥–ª–æ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å—Å—è –∫–∞–∫ "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ".

–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏: ${msg}`
          );
        }else if(name === "SecurityError"){
          alert(
`–ú–∏–∫—Ä–æ—Ñ–æ–Ω –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ–ª–∏—Ç–∏–∫–æ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

–û–±—ã—á–Ω–æ –ø—Ä–∏—á–∏–Ω–∞: —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –Ω–µ HTTPS –∏–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω—ã–π.
–û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ HTTPS –∏–ª–∏ —á–µ—Ä–µ–∑ localhost.

–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏: ${msg}`
          );
        }else if(name === "NotFoundError" || name === "DevicesNotFoundError"){
          alert("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ.");
        }else{
          alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω: ${name}\n${msg}`);
        }

        showError(err, "getUserMedia (microphone permission)");
        showToast("–ú–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
        return false;
      }
    }

    async function startDictation(){
      try{
        if(!recognition) recognition = initSpeech();
        if(!recognition){
          alert("Web Speech API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º.");
          return;
        }
        if(recognizing) return;

        // –í–ê–ñ–ù–û: —Å–Ω–∞—á–∞–ª–∞ –∑–∞–ø—Ä–æ—Å–∏–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ, –∏–Ω–∞—á–µ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –±—É–¥–µ—Ç –æ—à–∏–±–∫–∞ ¬´–Ω–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è¬ª.
        const ok = await ensureMicPermission();
        if(!ok) return;

        recognizing = true;
        setMicUI(true);

        let finalTextBuffer = "";

        recognition.onresult = (event) => {
          let interim = "";
          for(let i = event.resultIndex; i < event.results.length; i++){
            const res = event.results[i];
            const txt = res[0]?.transcript || "";
            if(res.isFinal) finalTextBuffer += txt;
            else interim += txt;
          }
          if(finalTextBuffer){
            insertTextAtCursor(finalTextBuffer);
            finalTextBuffer = "";
          }
        };

        recognition.onerror = (e) => {
          showError(e.error || e, "SpeechRecognition");
          stopDictation();
        };

        recognition.onend = () => {
          recognizing = false;
          setMicUI(false);
        };

        recognition.start();
      }catch(err){ showError(err, "startDictation"); }
    }
function stopDictation(){
      try{
        if(!recognition) return;
        recognizing = false;
        setMicUI(false);
        recognition.onresult = null;
        recognition.onerror = null;
        recognition.onend = null;
        try{ recognition.stop(); }catch(_){}
      }catch(err){ showError(err, "stopDictation"); }
    }

    function insertTextAtCursor(text){
      const t = String(text || "");
      if(!t) return;

      if(state.ui.editorMode === "visual"){
        visualEditor.focus();
        document.execCommand('insertText', false, t);
        scheduleEditorPersist();
      }else{
        const ta = codeEditor;
        const start = ta.selectionStart ?? ta.value.length;
        const end = ta.selectionEnd ?? ta.value.length;
        ta.value = ta.value.slice(0, start) + t + ta.value.slice(end);
        const pos = start + t.length;
        ta.selectionStart = ta.selectionEnd = pos;
        ta.focus();
        scheduleEditorPersist();
      }
    }

    document.getElementById('btnMic').addEventListener('click', () => {
      if(recognizing) stopDictation();
      else startDictation();
    });

    
    document.getElementById('btnMicPerm').addEventListener('click', async () => {
      // –û—Ç–¥–µ–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ ¬´–ø–æ–ø—Ä–æ—Å–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ¬ª (—É–¥–æ–±–Ω–æ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö).
      const ok = await ensureMicPermission();
      if(ok) showToast("–ú–∏–∫—Ä–æ—Ñ–æ–Ω —Ä–∞–∑—Ä–µ—à—ë–Ω ‚úÖ");
    });
// ---------- Backup / Import ----------
    document.getElementById('btnExport').addEventListener('click', () => {
      try{
        saveNow();
        const data = JSON.stringify(state, null, 2);
        const blob = new Blob([data], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `litrpg-omnitool-backup_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.json`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        setTimeout(() => URL.revokeObjectURL(url), 1000);
        showToast("–ë—ç–∫–∞–ø —Å–∫–∞—á–∞–Ω ‚¨áÔ∏è");
      }catch(err){ showError(err, "btnExport"); }
    });

    const importFile = document.getElementById('importFile');
    document.getElementById('btnImport').addEventListener('click', async () => {
      try{
        const f = importFile.files?.[0];
        if(!f){
          alert("–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª JSON –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞.");
          return;
        }
        const ok = confirm("–ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω–∏—Ç —Ç–µ–∫—É—â—É—é –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?");
        if(!ok) return;

        const text = await f.text();
        const parsed = JSON.parse(text);

        // basic validation
        if(!parsed || !parsed.library || !Array.isArray(parsed.library.books)){
          alert("JSON –Ω–µ –ø–æ—Ö–æ–∂ –Ω–∞ –±—ç–∫–∞–ø Omni-Tool.");
          return;
        }
        state = parsed;
        saveNow();
        renderAll();
        showToast("–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω ‚úÖ");
      }catch(err){
        showError(err, "btnImport");
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å JSON. –°–º–æ—Ç—Ä–∏ –æ—à–∏–±–∫—É —Å–≤–µ—Ä—Ö—É.");
      }
    });

    document.getElementById('btnResetApp').addEventListener('click', () => {
      try{
        const ok = confirm("–°–±—Ä–æ—Å–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è? –≠—Ç–æ —É–¥–∞–ª–∏—Ç –∫–Ω–∏–≥–∏, —Ç–µ–∫—Å—Ç –∏ RPG-—Å–∏—Å—Ç–µ–º—ã.");
        if(!ok) return;
        localStorage.removeItem(LS_KEY);
        state = DEFAULT_STATE();
        saveNow();
        renderAll();
        showToast("–°–±—Ä–æ—Å –≤—ã–ø–æ–ª–Ω–µ–Ω üß®");
      }catch(err){ showError(err, "btnResetApp"); }
    });

    // ---------- Misc ----------
    function updateTopChip(){
      const b = getCurrentBook();
      const c = getCurrentChapter(b);
      chipBookTitle.textContent = b?.title || "‚Äî";
      chipChapterTitle.textContent = c ? c.title : "‚Äî";
    }

    function escapeHTML(s){
      return String(s ?? "").replace(/[&<>"']/g, m => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }
    function escapeAttr(s){ return escapeHTML(s); }

    function formatNum(v){
      if(v == null) return "‚Äî";
      if(typeof v !== "number") v = Number(v);
      if(Number.isNaN(v)) return "NaN";
      if(!Number.isFinite(v)) return String(v);
      const isInt = Math.abs(v - Math.round(v)) < 1e-9;
      return isInt ? String(Math.round(v)) : v.toFixed(2);
    }

    // Tiny toast
    let toastTimer = null;
    function showToast(text){
      try{
        clearTimeout(toastTimer);
        let t = document.getElementById('toast');
        if(!t){
          t = document.createElement('div');
          t.id = 'toast';
          t.style.position = 'fixed';
          t.style.left = '12px';
          t.style.right = '12px';
          t.style.bottom = '90px';
          t.style.zIndex = '9998';
          t.style.padding = '12px 14px';
          t.style.borderRadius = '18px';
          t.style.border = '1px solid rgba(0,229,255,.35)';
          t.style.background = 'linear-gradient(180deg, rgba(12,13,24,.92), rgba(10,11,18,.82))';
          t.style.boxShadow = '0 18px 46px rgba(0,0,0,.45)';
          t.style.color = 'var(--txt)';
          t.style.fontSize = '13px';
          t.style.backdropFilter = 'blur(10px)';
          t.style.transform = 'translateY(6px)';
          t.style.opacity = '0';
          t.style.transition = 'opacity .16s ease, transform .16s ease';
          document.body.appendChild(t);
        }
        t.textContent = text;
        requestAnimationFrame(() => {
          t.style.opacity = '1';
          t.style.transform = 'translateY(0)';
        });
        toastTimer = setTimeout(() => {
          t.style.opacity = '0';
          t.style.transform = 'translateY(6px)';
        }, 1400);
      }catch(_){}
    }

    
    // ---------- Settings UI ----------
    function activateSettingsPane(pane){
      const panes = Array.from(document.querySelectorAll('[data-seg-pane]'));
      const btns = Array.from(document.querySelectorAll('.segBtn'));
      const p = pane || SAFE_STORE.get('litrpg_settingsPane', 'general') || 'general';
      panes.forEach(el => el.style.display = (el.dataset.segPane === p) ? 'block' : 'none');
      btns.forEach(b => {
        const on = (b.dataset.seg === p);
        b.classList.toggle('active', on);
        b.setAttribute('aria-selected', on ? 'true' : 'false');
      });
      SAFE_STORE.set('litrpg_settingsPane', p);
    }

    function syncSettingsControls(){
      try{
        const theme = document.documentElement.dataset.theme || 'dark';
        const compact = document.body.classList.contains('compact');
        const focus = document.getElementById('app')?.classList.contains('focusMode') || false;

        const reduceMotion = document.body.classList.contains('reducedMotion');
        const haptics = SAFE_STORE.get('litrpg_haptics', '0') === '1';
        const fontScale = Number(SAFE_STORE.get('litrpg_fontScale', '100')) || 100;

        const c = document.getElementById('setCompactToggle');
        if(c) c.checked = compact;
        const f = document.getElementById('setFocusToggle');
        if(f) f.checked = !!state.ui.focus && focus;
        const rm = document.getElementById('setReduceMotion');
        if(rm) rm.checked = reduceMotion;
        const h = document.getElementById('setHaptics');
        if(h) h.checked = haptics;
        const fs = document.getElementById('setFontScale');
        if(fs) fs.value = String(fontScale);
        applyFontScale(fontScale);

        // Theme buttons (highlight)
        const td = document.getElementById('setThemeDark');
        const tl = document.getElementById('setThemeLight');
        if(td) td.classList.toggle('primary', theme === 'dark');
        if(tl) tl.classList.toggle('primary', theme === 'light');
      }catch(_){}
    }

    function initSettingsUI(){
      // segmented tabs
      document.querySelectorAll('.segBtn').forEach(btn => {
        btn.addEventListener('click', () => { hapticTap(); activateSettingsPane(btn.dataset.seg); });
      });

      // theme
      const bDark = document.getElementById('setThemeDark');
      const bLight = document.getElementById('setThemeLight');
      if(bDark) bDark.addEventListener('click', () => { hapticTap(); applyTheme('dark'); syncSettingsControls(); });
      if(bLight) bLight.addEventListener('click', () => { hapticTap(); applyTheme('light'); syncSettingsControls(); });

      // toggles
      const compact = document.getElementById('setCompactToggle');
      if(compact) compact.addEventListener('change', () => { hapticTap(); applyCompact(compact.checked); syncSettingsControls(); });

      const focus = document.getElementById('setFocusToggle');
      if(focus) focus.addEventListener('change', () => {
        hapticTap();
        state.ui.focus = !!focus.checked;
        scheduleSave();
        applyFocusMode();
        syncSettingsControls();
      });

      const rm = document.getElementById('setReduceMotion');
      if(rm) rm.addEventListener('change', () => { hapticTap(); applyReduceMotion(rm.checked); syncSettingsControls(); });

      const h = document.getElementById('setHaptics');
      if(h) h.addEventListener('change', () => { hapticTap(); SAFE_STORE.set('litrpg_haptics', h.checked ? '1' : '0'); syncSettingsControls(); });

      const fs = document.getElementById('setFontScale');
      if(fs) fs.addEventListener('input', () => { applyFontScale(fs.value); });

      // quick open
      const oW = document.getElementById('btnOpenWrite');
      if(oW) oW.addEventListener('click', () => setTab('write', {pushHash:true}));
      const oG = document.getElementById('btnOpenGod');
      if(oG) oG.addEventListener('click', () => setTab('god', {pushHash:true}));
      const oL = document.getElementById('btnOpenLibrary');
      if(oL) oL.addEventListener('click', () => setTab('library', {pushHash:true}));

      // initial state
      activateSettingsPane(SAFE_STORE.get('litrpg_settingsPane', 'general'));
      syncSettingsControls();

      // keep controls synced when using topbar quick buttons
      if(btnTheme) btnTheme.addEventListener('click', () => setTimeout(syncSettingsControls, 0));
      if(btnCompact) btnCompact.addEventListener('click', () => setTimeout(syncSettingsControls, 0));
      const focusBtn = document.getElementById('btnFocus');
      if(focusBtn) focusBtn.addEventListener('click', () => setTimeout(syncSettingsControls, 0));
    }

// ---------- Render all ----------
    function renderAll(){
      try{
        applyFocusMode();
        renderTabs();
        renderBookList();
        renderTree();
        renderAttrs();
        renderDerived();
        renderHero();
        applyEditorMode();
        loadChapterToEditor();
      }catch(err){
        showError(err, "renderAll");
      }
    }

    // ---------- Quick wiring for chapter persistence on book switch/tab ----------
    const originalSetTab = setTab;
    setTab = function(tab, opts={}){
      try{
        // if leaving editor, persist current text
        if(state.ui.tab === "write" && tab !== "write"){
          persistEditorToChapter();
        }
      }catch(err){ showError(err, "persist on tab change"); }
      originalSetTab(tab, opts);
    };

    // ---------- Start ----------
    (function boot(){
      try{
        if(!state.library.books.length){
          state = DEFAULT_STATE();
          saveNow();
        }
        if(!state.library.books.some(b => b.id === state.currentBookId)){
          state.currentBookId = state.library.books[0].id;
        }
        setCurrentBook(state.currentBookId);
        // migrate old tab name
        if(state.ui && state.ui.tab === "backup") state.ui.tab = "settings";
        applyFocusMode();

        // Hash-router (back button friendly)
        const hashTab = (location.hash || '').replace('#','').trim();
        if(hashTab && tabEls[hashTab]) state.ui.tab = hashTab;
        window.addEventListener('hashchange', () => {
          const t = (location.hash || '').replace('#','').trim();
          if(t && tabEls[t]) setTab(t, {pushHash:false});
        });

        renderAll();
        initSettingsUI();


        
        // –ü–æ–∫–∞–∂–µ–º/—Å–ø—Ä—è—á–µ–º –∫–Ω–æ–ø–∫—É —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
        try{
          const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
          const canMic = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
          const permBtn = document.getElementById('btnMicPerm');
          if(permBtn){
            permBtn.style.display = (SR && canMic) ? "inline-flex" : "none";
          }
        }catch(_){}
setInterval(() => {
          try{ saveNow(); }catch(_){}
        }, 6000);

      }catch(err){
        showError(err, "boot");
      }
    })();
  
// =====================
// Voice Dictation (ADVANCED FIXED)
// =====================
const SpeechRecognition =
  window.SpeechRecognition || window.webkitSpeechRecognition;

let recognition = null;
let isDictationActive = false;
let lastFinalTranscript = "";

const btnMicStart = document.getElementById("btnMicStart");
const btnMicStop = document.getElementById("btnMicStop");
const micBadge = document.getElementById("micBadge");
const editor = document.getElementById("visualEditor");

function insertTextAtCursor(text) {
  const sel = window.getSelection();
  if (!sel || !sel.rangeCount) {
    editor.innerHTML += text;
    return;
  }
  const range = sel.getRangeAt(0);
  range.deleteContents();
  range.insertNode(document.createTextNode(text));
  range.collapse(false);
  sel.removeAllRanges();
  sel.addRange(range);
}

function smartPunctuation(text) {
  text = text.trim();
  if (!text) return "";
  if (!/[.!?]$/.test(text)) text += ".";
  return text;
}

function startDictation() {
  if (!SpeechRecognition) {
    alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–æ–ª–æ—Å–æ–≤–æ–π –≤–≤–æ–¥.");
    return;
  }
  if (isDictationActive) return;

  recognition = new SpeechRecognition();
  recognition.lang = "ru-RU";
  recognition.continuous = true;
  recognition.interimResults = false;

  lastFinalTranscript = "";
  isDictationActive = true;

  recognition.onresult = (event) => {
    let finalText = "";

    for (let i = event.resultIndex; i < event.results.length; i++) {
      const res = event.results[i];
      if (res.isFinal) {
        finalText += res[0].transcript;
      }
    }

    finalText = finalText.trim();
    if (!finalText || finalText === lastFinalTranscript) return;
    lastFinalTranscript = finalText;

    insertTextAtCursor(smartPunctuation(finalText) + " ");
    scheduleSave();
  };

  recognition.onerror = (e) => console.warn("Speech error:", e.error);

  recognition.onend = () => {
    if (isDictationActive) {
      try { recognition.start(); } catch (_) {}
    }
  };

  recognition.start();

  btnMicStart.disabled = true;
  btnMicStop.disabled = false;
  micBadge.style.display = "inline-flex";
}

function stopDictation() {
  if (!isDictationActive) return;
  isDictationActive = false;
  try {
    recognition.onend = null;
    recognition.stop();
  } catch (_) {}
  recognition = null;
  btnMicStart.disabled = false;
  btnMicStop.disabled = true;
  micBadge.style.display = "none";
}

btnMicStart.addEventListener("click", startDictation);
btnMicStop.addEventListener("click", stopDictation);


/* ===============================
   FIX: Bottom navigation init
   =============================== */
(function(){
  try{
    const navButtons = document.querySelectorAll('.navBtn');
    if(!navButtons.length) return;

    const tabs = {
      library: document.getElementById('tab-library'),
      god: document.getElementById('tab-god'),
      hero: document.getElementById('tab-hero'),
      write: document.getElementById('tab-write'),
      settings: document.getElementById('tab-settings'),
    };

    function showTab(name){
      Object.values(tabs).forEach(t => { if(t) t.style.display = 'none'; });
      if(tabs[name]) tabs[name].style.display = '';
      navButtons.forEach(btn =>
        btn.classList.toggle('active', btn.dataset.tab === name)
      );
      if(window.state && state.ui){
        state.ui.tab = name;
        if(typeof scheduleSave === 'function') scheduleSave();
      }
    }

    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        if(tab) showTab(tab);
      });
    });

    const startTab =
      (window.state && state.ui && state.ui.tab) || 'write';
    showTab(startTab);
  }catch(e){
    console.error("Navigation init failed", e);
  }
})();

</script>
</body>
</html>
